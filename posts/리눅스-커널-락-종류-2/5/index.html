<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>ë¦¬ëˆ…ìŠ¤ ì»¤ë„ ë½ ì¢…ë¥˜ (2/5) | Sukbeom Kim</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">    
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description" content="ì§€ë‚œ ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” ë¦¬ëˆ…ìŠ¤ ì»¤ë„ ë½ ì¤‘ í•˜ë‚˜ì¸ ìŠ¤í•€ë½(Spinlock)ì— ëŒ€í•´ ê¸°ìˆ í•˜ì˜€ë‹¤. ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” ë®¤í…ìŠ¤(Mutex)ì— ëŒ€í•´ì„œ ê¸°ìˆ í•˜ê³ ì í•œë‹¤">
<meta name="generator" content="Hugo 0.121.2">


  <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="stylesheet" href="/css/style.css">


  
    
    <link rel="stylesheet" href="/css/img.css">
  

  
    
    <link rel="stylesheet" href="/css/noto_sans_kr.css">
  

  
    
    <link rel="stylesheet" href="/css/nanumgothic.css">
  


<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />

 
    
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-Y7VW74D2P3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js" integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js" integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>




  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">â†</span>Home</a>
	
	<a href="/posts">Archive</a>
	<a href="/tags">Tags</a>
	<a href="/about">About</a>

	

	
	  <a class="button" href="/index.xml">Subscribe</a>
	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">ë¦¬ëˆ…ìŠ¤ ì»¤ë„ ë½ ì¢…ë¥˜ (2/5)</h1>

    <div class="tip">
        <time datetime="2019-05-29 00:59:34 &#43;0900 KST">May 29, 2019</time>
        <span class="split">
          Â·
        </span>
        <span>
          1524 words
        </span>
        <span class="split">
          Â·
        </span>
        <span>
          4 minute read
        </span>
    </div>

    
    
        
  


    


    <div class="content">
      <p>ì§€ë‚œ ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” ë¦¬ëˆ…ìŠ¤ ì»¤ë„ ë½ ì¤‘ í•˜ë‚˜ì¸ ìŠ¤í•€ë½(Spinlock)ì— ëŒ€í•´
ê¸°ìˆ í•˜ì˜€ë‹¤. ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” ë®¤í…ìŠ¤(Mutex)ì— ëŒ€í•´ì„œ ê¸°ìˆ í•˜ê³ ì
í•œë‹¤. ë§ì€ ê³³ì—ì„œ ë®¤í…ìŠ¤ëŠ” ì„¸ë§ˆí¬ì–´ì˜ ì¹´ìš´íŠ¸ ê°’ì´ ë‹¨ìˆœí•˜ê²Œ 1ë¡œ
ì„¤ì •ë˜ì—ˆì„ ë•Œë¥¼ ë§í•œë‹¤ê³  ê¸°ìˆ í•œë‹¤. í•˜ì§€ë§Œ ì´ê²ƒì´ ë§ëŠ” ì„¤ëª…ì¼ê¹Œ?</p>
<p><a href="https://www.tutorialspoint.com/mutex-vs-semaphore" target="_blank" rel="noopener">ì°¸ê³  ìë£Œ</a>ì—
ë”°ë¥´ë©´ ë®¤í…ìŠ¤ëŠ” ê³µìœ  ìì›ìœ¼ë¡œì˜ ì ‘ê·¼(Access)ì— ëŒ€í•œ ìƒí˜¸ ë°°ì œ(Mutual
Exclusion)ì„ ìœ„í•œ ìˆ˜ë‹¨ì´ <code>Mutex</code>ë¼ê³  ì •ì˜í•˜ê³  ìˆë‹¤. ì´ì— ë°˜í•´
<code>ì„¸ë§ˆí¬ì–´(Semaphore)</code>ëŠ” ì‹œê·¸ë„ ë§¤ì»¤ë‹ˆì¦˜ìœ¼ë¡œì„œ ìŠ¤ë ˆë“œ(ë˜ëŠ” í”„ë¡œì„¸ìŠ¤) ê°„
ë™ê¸°í™”ê°€ ì£¼ ëª©ì ìœ¼ë¡œ, <code>wait</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œ ìŠ¤ë ˆë“œë§Œì´ ë®¤í…ìŠ¤ë¥¼ ì‹ í˜¸ë¥¼
ë³´ë‚¼ ìˆ˜ ìˆë‹¤ëŠ” ì ì´ ê¸°ëŠ¥ì ì¸ íŠ¹ì§•ì´ë‹¤.  ì‰½ê²Œ ë§í•´,
<strong>ì„¸ë§ˆí¬ì–´(Semaphore)ëŠ” ì„ê³„ êµ¬ì—­(Critical Section)ì„ ì‹¤í–‰í•˜ë ¤í•˜ëŠ”
ì—¬ëŸ¬ ê°œì˜ í”„ë¡œì„¸ìŠ¤ë“¤ì„ ì œí•œí•˜ë©° ë™ê¸°í™”í•˜ê³ , ë®¤í…ìŠ¤(Mutex)ëŠ” ì˜¤ì§ í•œ
ë²ˆì— í•œ ê°œ í”„ë¡œì„¸ìŠ¤ì—ì„œ ìì›ì— ëŒ€í•œ ì ‘ê·¼ì„ ì œí•œí•˜ëŠ” ê²ƒì´ mutexì´ì
mutual exclusionì´ë¼ëŠ” ëª©ì ì´ë‹¤.</strong></p>
<p>ë®¤í…ìŠ¤ëŠ” ì¹´ìš´íŠ¸ 1ì¸ ì„¸ë§ˆí¬ì–´ì²˜ëŸ¼ ìƒí˜¸ ë°°ì œì„±ì„ ê°€ì§„ íœ´ë©´ ê°€ëŠ¥í•œ
ë½ì´ì§€ë§Œ ì„¸ë§ˆí¬ì–´ë³´ë‹¤ ë¶€ê°€ì ì¸ ì œì•½ ì‚¬í•­ì„ ê°€ì§€ê³  ìˆë‹¤.</p>
<ul>
<li>
<p>í•œ íƒœìŠ¤í¬ëŠ” í•œ ë²ˆì— í•˜ë‚˜ì˜ ë®¤í…ìŠ¤ë§Œ ì–»ì„ ìˆ˜ ìˆë‹¤. ì¦‰, ë®¤í…ìŠ¤ì˜ ì‚¬ìš©
ì¹´ìš´íŠ¸ ê°’ì€ í•­ìƒ 1ì´ë‹¤.</p>
</li>
<li>
<p>ë®¤í…ìŠ¤ë¥¼ ì–»ì€ ê³³ì—ì„œë§Œ ë®¤í…ìŠ¤ë¥¼ í•´ì œí•  ìˆ˜ ìˆë‹¤. ì´ ë•Œë¬¸ì— í•œ
ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì–»ì€ ë®¤í…ìŠ¤ë¥¼ ë‹¤ë¥¸ ì»¨í…ìŠ¤íŠ¸ì—ì„œ í•´ì œí•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ,
ì»¤ë„ê³¼ ì‚¬ìš©ì ê³µê°„ ì‚¬ì´ì˜ ë³µì¡í•œ ë™ê¸°í™”ì— ì‚¬ìš©í•˜ê¸°ì—ëŠ” ë¶€ì ì ˆí•˜ë‹¤.</p>
</li>
<li>
<p>ì¬ê·€ì ìœ¼ë¡œ ë½ì„ ì–»ê³  í•´ì œí•  ìˆ˜ ì—†ë‹¤. ê°™ì€ ë®¤í…ìŠ¤ë¥¼ ì¬ê·€ì ìœ¼ë¡œ ì—¬ëŸ¬
ë²ˆ ì–»ì„ ìˆ˜ ì—†ìœ¼ë©° í•´ì œëœ ë®¤í…ìŠ¤ë¥¼ í•œë²ˆ ë” í•´ì œí•  ìˆ˜ë„ ì—†ë‹¤.</p>
</li>
<li>
<p>ë®¤í…ìŠ¤ë¥¼ ê°€ì§€ê³  ìˆëŠ” ë™ì•ˆì—ëŠ” í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œê°€ ë¶ˆê°€ëŠ¥í•˜ë‹¤.</p>
</li>
<li>
<p>ì¸í„°ëŸ½íŠ¸ í•¸ë“¤ëŸ¬ë‚˜ í›„ë°˜ë¶€ ì²˜ë¦¬ ì‘ì—… ë‚´ì—ì„œëŠ” ë®¤í…ìŠ¤ë¥¼ ì–»ì„ ìˆ˜ ì—†ìœ¼ë©°,
mutex_trylock() í•¨ìˆ˜ë„ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.</p>
</li>
<li>
<p>ë®¤í…ìŠ¤ëŠ” ê³µì‹ APIë¥¼ í†µí•´ì„œë§Œ ê´€ë¦¬í•  ìˆ˜ ìˆë‹¤. ë˜í•œ ë®¤í…ìŠ¤ë¥¼
ë³µì‚¬í•˜ê±°ë‚˜ ì´ˆê¸°í™” ìƒíƒœ ì „ë‹¬, ì¬ ì´ˆê¸°í™”í•˜ëŠ” ì‘ì—…ì€ ë¶ˆê°€ëŠ¥í•˜ë‹¤.</p>
</li>
</ul>
<p>ê·¸ë ‡ë‹¤ë©´ ì–´ë–¤ ê²½ìš°ì— ë®¤í…ìŠ¤ì™€ ìŠ¤í•€ë½, ì„¸ë§ˆí¬ì–´ ì¤‘ì—ì„œ ë®¤í…ìŠ¤ë¥¼
ì„ íƒí•´ì•¼ í•˜ëŠ”ê°€? ë®¤í…ìŠ¤ì™€ ì„¸ë§ˆí¬ì–´ì˜ ì„ íƒì—ëŠ” <strong>ë™ê¸°í™” ì—¬ë¶€</strong>ë¥¼,
ë®¤í…ìŠ¤ì™€ ìŠ¤í•€ë½ì˜ ì„ íƒì—ì„œëŠ” <strong>ì¸í„°ëŸ½íŠ¸ ì»¨í…ìŠ¤íŠ¸ ì—¬ë¶€ì™€ ë½
ì‚¬ìš©ì‹œê°„</strong>ì„ ë¹„êµí•˜ì—¬ ì„ íƒí•  ìˆ˜ ìˆë‹¤.<br><br></p>
<table>
<thead>
<tr>
<th>ìš”êµ¬ì‚¬í•­</th>
<th>ì¶”ì²œ Lock</th>
</tr>
</thead>
<tbody>
<tr>
<td>ë½ ë¶€ë‹´ì´ ì ì–´ì•¼ í•˜ëŠ” ê²½ìš°</td>
<td>ìŠ¤í•€ë½</td>
</tr>
<tr>
<td>ë½ì˜ ì‚¬ìš©ì‹œê°„ì´ ì§§ì•„ì•¼ í•  ë•Œ</td>
<td>ìŠ¤í•€ë½</td>
</tr>
<tr>
<td>ë½ ì‚¬ìš©ì‹œê°„ì´ ê¸¸ ë•Œ</td>
<td>ë®¤í…ìŠ¤</td>
</tr>
<tr>
<td>ì¸í„°ëŸ½íŠ¸ ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë½ì„ ì‚¬ìš©í•  ë•Œ</td>
<td>ë°˜ë“œì‹œ ìŠ¤í•€ë½</td>
</tr>
<tr>
<td>ë½ì„ ì–»ì€ ìƒíƒœì—ì„œ íœ´ë©´í•  í•„ìš”ê°€ ìˆì„ ë•Œ</td>
<td>ë°˜ë“œì‹œ ë®¤í…ìŠ¤</td>
</tr>
</tbody>
</table>
<p>ë®¤í…ìŠ¤ì— ê´€ë ¨ëœ ì˜ˆì œëŠ” ê°„ë‹¨í•˜ë‹¤. ì• ì´ˆì— ë®¤í…ìŠ¤ì— ê´€ë ¨ëœ APIê°€ ê°„ë‹¨í• 
ë¿ë”ëŸ¬ ë½ì„ ì–»ì€ ì»¨í…ìŠ¤íŠ¸ì—ì„œ í•´ë‹¹ ë½ì„ í•´ì œí•´ì•¼ í•˜ëŠ” ì œì•½ì‚¬í•­ì´ ìˆê¸°
ë•Œë¬¸ì´ë‹¤.</p>
<p>ì´ì œ ë®¤í…ìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ” ì½”ë“œ ì˜ˆì œë¥¼ ê°„ë‹¨í•˜ê²Œ ì‚´í´ë³´ì. ë¨¼ì € ìœ ì €
ë ˆë²¨ì—ì„œ ë™ì‘í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œì´ë‹¤.</p>
<p>#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;pthread.h&gt;
#include &lt;string.h&gt;</p>
<p>pthread_t tid[2];
pthread_mutex_t lock;
int counter;</p>
<p>void* trythis (void *arg) {
pthread_mutex_lock(&amp;lock);</p>
<pre><code>unsigned long i = 0;
counter += 1;
printf(&quot;\n Job %d has started\n&quot;, counter);

for (i=0; i&lt;(0x9999); i++);

printf(&quot;\n Job %d has finished\n&quot;, counter);

pthread_mutex_unlock(&amp;lock);
return NULL;
</code></pre>
<p>}</p>
<p>int main(int argc, char* argv[]) {
int i = 0;
int error;</p>
<pre><code>if (pthread_mutex_init(&amp;lock, NULL) != 0) {
    printf(&quot;\nMutex init has failed\n&quot;);
    return 1;
}

while (i &lt; 2) {
    error = pthread_create(&amp;(tid[i]), NULL, &amp;trythis, NULL);
    if (error != 0) {
        printf(&quot;\nThread can't be created: %s&quot;, strerror(error));
    }
    i++;
}

pthread_join(tid[0], NULL);
pthread_join(tid[1], NULL);
pthread_mutex_destroy(&amp;lock);

return 0;
</code></pre>
<p>}</p>
<p><code>void* trythis(void* arg)</code> í•¨ìˆ˜ ë‚´ ë®¤í…ìŠ¤ë¡œ ì¸í•´ ìŠ¤ë ˆë“œê°€ ë½ì„ ì–»ì€
ìˆœì„œ(Thread 1 -&gt; Thread 2)ëŒ€ë¡œ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p>
<p>ê·¸ë ‡ë‹¤ë©´, ìœ ì € ë ˆë²¨ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì•„ë‹Œ ì»¤ë„ ëª¨ë“ˆì—ì„œëŠ” ë®¤í…ìŠ¤ë¥¼ ì–´ë–¤
ì‹ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆì„ê¹Œ? ì—¬ê¸°ì— ëŒ€í•œ ì˜ˆì œëŠ” <a href="https://www.kernel.org/doc/htmldocs/kernel-locking/Examples.html" target="_blank" rel="noopener">ì»¤ë„
ë¬¸ì„œ</a>ì—ì„œ
ì‰½ê²Œ ì°¾ì„ ìˆ˜ ìˆì—ˆë‹¤.</p>
<p>#include &lt;linux/list.h&gt;
#include &lt;linux/slab.h&gt;
#include &lt;linux/string.h&gt;
#include &lt;linux/mutex.h&gt;
#include &lt;asm/errno.h&gt;</p>
<p>struct object
{
struct list_head list;
int id;
char name[32];
int popularity;
};</p>
<p>/* Protects the cache, cache_num, and the objects within it */
static DEFINE_MUTEX(cache_lock);
static LIST_HEAD(cache);
static unsigned int cache_num = 0;
#define MAX_CACHE_SIZE 10</p>
<p>/* Must be holding cache_lock */
static struct object *__cache_find(int id)
{
struct object *i;</p>
<pre><code>    list_for_each_entry(i, &amp;cache, list)
            if (i-&gt;id == id) {
                    i-&gt;popularity++;
                    return i;
            }
    return NULL;
</code></pre>
<p>}</p>
<p>/* Must be holding cache_lock */
static void __cache_delete(struct object *obj)
{
BUG_ON(!obj);
list_del(&amp;obj-&gt;list);
kfree(obj);
cache_num&ndash;;
}</p>
<p>/* Must be holding cache_lock */
static void __cache_add(struct object *obj)
{
list_add(&amp;obj-&gt;list, &amp;cache);
if (++cache_num &gt; MAX_CACHE_SIZE) {
struct object *i, *outcast = NULL;
list_for_each_entry(i, &amp;cache, list) {
if (!outcast || i-&gt;popularity &lt; outcast-&gt;popularity)
outcast = i;
}
__cache_delete(outcast);
}
}</p>
<p>int cache_add(int id, const char *name)
{
struct object *obj;</p>
<pre><code>    if ((obj = kmalloc(sizeof(*obj), GFP_KERNEL)) == NULL)
            return -ENOMEM;

    strlcpy(obj-&gt;name, name, sizeof(obj-&gt;name));
    obj-&gt;id = id;
    obj-&gt;popularity = 0;

    mutex_lock(&amp;cache_lock);
    __cache_add(obj);
    mutex_unlock(&amp;cache_lock);
    return 0;
</code></pre>
<p>}</p>
<p>void cache_delete(int id)
{
mutex_lock(&amp;cache_lock);
__cache_delete(__cache_find(id));
mutex_unlock(&amp;cache_lock);
}</p>
<p>int cache_find(int id, char *name)
{
struct object *obj;
int ret = -ENOENT;</p>
<pre><code>    mutex_lock(&amp;cache_lock);
    obj = __cache_find(id);
    if (obj) {
            ret = 0;
            strcpy(name, obj-&gt;name);
    }
    mutex_unlock(&amp;cache_lock);
    return ret;
</code></pre>
<p>}</p>
<h1 id="ì¶œì²˜">ì¶œì²˜ <a href="#%ec%b6%9c%ec%b2%98" class="anchor">ğŸ”—</a></h1><ul>
<li><a href="https://www.tutorialspoint.com/mutex-vs-semaphore" target="_blank" rel="noopener">Mutex
vs. Semaphore</a></li>
<li><a href="http://tuxthink.blogspot.com/2011/05/using-semaphores-in-linux.html" target="_blank" rel="noopener">Using Semaphore in
Linux</a></li>
<li><a href="https://www.geeksforgeeks.org/mutex-lock-for-linux-thread-synchronization/" target="_blank" rel="noopener">mutex lock for linux thread
synchronization</a></li>
<li><a href="https://www.kernel.org/doc/htmldocs/kernel-locking/Examples.html" target="_blank" rel="noopener">An example of Kernel Locking</a></li>
</ul>

    </div>

    
        <div class="tags">
            
                <a href="/tags/mutex">mutex</a>
            
                <a href="/tags/semaphore">semaphore</a>
            
                <a href="/tags/spinlock">spinlock</a>
            
                <a href="/tags/global-kernel-lock">global kernel lock</a>
            
        </div>
    
    
    

</section>


    </main>
    
    <footer id="footer">
    

    <div class="copyright">
    
        Copyright - Sukbeom Kim
    
    </div>

    
</footer>



  </body>
</html>
