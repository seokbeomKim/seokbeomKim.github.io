<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>Stack Protectorì™€ ë””ë²„ê¹… ì´ì•¼ê¸° | Sukbeom Kim</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">    
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description" content="Stack Protector, ë„Œ ë­í•˜ëŠ” ë†ˆì´ëƒ? ğŸ”—í˜„ì—…ì—ì„œ ì»¤ë„ì˜ CONFIG_STACK_PROTECTOR ë¥¼ í™œì„±í™”í•˜ë©´ ì»¤ë„ ë¶€íŠ¸ê°€ ì•ˆëœë‹¤ëŠ” ì´ìŠˆê°€ ë³´ê³ ë˜ì—ˆë‹¤. Trace32 ë¡œ callstackì„ ì‚´í´ë³´ë‹ˆ ë‚´ íŒŒíŠ¸ì—ì„œ ë§¡ê³  ìˆëŠ” ë””ë°”">
<meta name="generator" content="Hugo 0.121.2">


  <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="stylesheet" href="/css/style.css">


  
    
    <link rel="stylesheet" href="https://seokbeomkim.github.iocss/img.css">
  

  
    
    <link rel="stylesheet" href="https://seokbeomkim.github.iocss/noto_sans_kr.css">
  

  
    
    <link rel="stylesheet" href="https://seokbeomkim.github.iocss/nanumgothic.css">
  


<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />

 
    
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-Y7VW74D2P3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js" integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js" integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>




  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">â†</span>Home</a>
	
	<a href="/posts">Archive</a>
	<a href="/tags">Tags</a>
	<a href="/about">About</a>

	

	
	  <a class="button" href="https://seokbeomkim.github.io/index.xml">Subscribe</a>
	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">Stack Protectorì™€ ë””ë²„ê¹… ì´ì•¼ê¸°</h1>

    <div class="tip">
        <time datetime="2022-02-03 15:00:45 &#43;0900 KST">Feb 3, 2022</time>
        <span class="split">
          Â·
        </span>
        <span>
          2316 words
        </span>
        <span class="split">
          Â·
        </span>
        <span>
          5 minute read
        </span>
    </div>

    
    
        
  
    <aside class="toc">
      <details>
          <summary>Table of Contents
          </summary>
          <div>
              <nav id="TableOfContents">
  <ul>
    <li><a href="#stack-protector-ë„Œ-ë­í•˜ëŠ”-ë†ˆì´ëƒ">Stack Protector, ë„Œ ë­í•˜ëŠ” ë†ˆì´ëƒ?</a></li>
    <li><a href="#ìŠ¤íƒ-ë ˆì´ì•„ì›ƒ-ì‚´í´ë³´ê¸°">ìŠ¤íƒ ë ˆì´ì•„ì›ƒ ì‚´í´ë³´ê¸°</a>
      <ul>
        <li><a href="#ë¹„í™œì„±í™”-ì‹œì˜-ë ˆì´ì•„ì›ƒ">ë¹„í™œì„±í™” ì‹œì˜ ë ˆì´ì•„ì›ƒ</a></li>
        <li><a href="#í™œì„±í™”-ì‹œì˜-ë ˆì´ì•„ì›ƒ">í™œì„±í™” ì‹œì˜ ë ˆì´ì•„ì›ƒ</a></li>
      </ul>
    </li>
    <li><a href="#stack-smashing-ì—ëŸ¬ê°€-ì•ˆë‚œë‹¤-canary-boundary">Stack Smashing ì—ëŸ¬ê°€ ì•ˆë‚œë‹¤? Canary Boundary</a></li>
    <li><a href="#ì°¸ê³ -ìë£Œ">ì°¸ê³  ìë£Œ</a></li>
  </ul>
</nav>
          </div>
      </details>
    </aside>
  


    


    <div class="content">
      <h2 id="stack-protector-ë„Œ-ë­í•˜ëŠ”-ë†ˆì´ëƒ">Stack Protector, ë„Œ ë­í•˜ëŠ” ë†ˆì´ëƒ? <a href="#stack-protector-%eb%84%8c-%eb%ad%90%ed%95%98%eb%8a%94-%eb%86%88%ec%9d%b4%eb%83%90" class="anchor">ğŸ”—</a></h2><p>í˜„ì—…ì—ì„œ ì»¤ë„ì˜ <code>CONFIG_STACK_PROTECTOR</code> ë¥¼ í™œì„±í™”í•˜ë©´ ì»¤ë„ ë¶€íŠ¸ê°€ ì•ˆëœë‹¤ëŠ” ì´ìŠˆê°€
ë³´ê³ ë˜ì—ˆë‹¤. Trace32 ë¡œ callstackì„ ì‚´í´ë³´ë‹ˆ ë‚´ íŒŒíŠ¸ì—ì„œ ë§¡ê³  ìˆëŠ” ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ ì½”ë“œ ë•Œë¬¸ì—
Stack Overflowê°€ ë°œìƒí•˜ì—¬ ë¶€íŠ¸ê°€ ì•ˆë˜ê³  ìˆì—ˆë‹¤. ë¬¸ì œì˜ ì§€ì ì€ ì‚¬ìˆ˜ê°€ ë°œê²¬í•˜ê³  íŒŒíŠ¸ì¥ì˜ ìˆ˜ì •ìœ¼ë¡œ ë§ˆë¬´ë¦¬ë˜ì—ˆë‹¤.</p>
<p>í•˜ì§€ë§Œ ì´ìŠˆê°€ ë§ˆë¬´ë¦¬ ë˜ê³  Stack Protector ê°€ ì–´ë–¤ ì›ë¦¬ë¡œ ë™ì‘í•˜ëŠ”ì§€ ê¶ê¸ˆí–ˆê³  ì„¤ ì—°íœ´ë¥¼
ë§ì•„ ìì„¸í•˜ê²Œ ì •ë¦¬í•  ìˆ˜ ìˆì—ˆë‹¤. ê·¸ ê³¼ì •ì—ì„œ ìš°ë¶„íˆ¬ì— ì˜ëª»ëœ ë²„ê·¸ ë¦¬í¬íŠ¸ í‹°ì¼“ì„
ë§Œë“¤ì–´ë‚´ê¸´ í–ˆì§€ë§Œ ë§ì´ë‹¤.</p>
<p>Stack Protectionì€ GCCì˜ <code>-fstack-protector, -fstack-protector-all, -fstack-protector-strong</code>
ì˜µì…˜ì„ í†µí•´ í™œì„±í™”í•  ìˆ˜ ìˆê³  <code>-fno-stack-protector</code> ì˜µì…˜ìœ¼ë¡œ ë¹„í™œì„±í™” í•  ìˆ˜ ìˆë‹¤.</p>
<h2 id="ìŠ¤íƒ-ë ˆì´ì•„ì›ƒ-ì‚´í´ë³´ê¸°">ìŠ¤íƒ ë ˆì´ì•„ì›ƒ ì‚´í´ë³´ê¸° <a href="#%ec%8a%a4%ed%83%9d-%eb%a0%88%ec%9d%b4%ec%95%84%ec%9b%83-%ec%82%b4%ed%8e%b4%eb%b3%b4%ea%b8%b0" class="anchor">ğŸ”—</a></h2><h3 id="ë¹„í™œì„±í™”-ì‹œì˜-ë ˆì´ì•„ì›ƒ">ë¹„í™œì„±í™” ì‹œì˜ ë ˆì´ì•„ì›ƒ <a href="#%eb%b9%84%ed%99%9c%ec%84%b1%ed%99%94-%ec%8b%9c%ec%9d%98-%eb%a0%88%ec%9d%b4%ec%95%84%ec%9b%83" class="anchor">ğŸ”—</a></h3><p>ë¨¼ì €, Stack Protectorë¥¼ ë¹„í™œì„±í™”/í™œì„±í™” ë˜ì—ˆì„ ë•Œì˜ ê°ê° ì½œìŠ¤íƒì´ ì–´ë–»ê²Œ ë˜ëŠ”ì§€ ì‚´í´ë³´ì.</p>
<p>ë¨¼ì €, ì•„ë˜ì™€ ê°™ì´ ê°„ë‹¨í•œ ì½”ë“œë¥¼ ì¤€ë¹„í•˜ì˜€ë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">mul</span>(<span style="color:#0b0;font-weight:bold">int</span> a)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        a <span style="color:#666">=</span> a <span style="color:#666">*</span> <span style="color:#666">2</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">add</span>(<span style="color:#0b0;font-weight:bold">int</span> a, <span style="color:#0b0;font-weight:bold">int</span> b, <span style="color:#0b0;font-weight:bold">int</span> c, <span style="color:#0b0;font-weight:bold">int</span> d)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        <span style="color:#0b0;font-weight:bold">int</span> j <span style="color:#666">=</span> a <span style="color:#666">+</span> <span style="color:#666">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#0b0;font-weight:bold">int</span> e <span style="color:#666">=</span> b <span style="color:#666">+</span> <span style="color:#666">2</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#0b0;font-weight:bold">int</span> f <span style="color:#666">=</span> c <span style="color:#666">+</span> <span style="color:#666">3</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#0b0;font-weight:bold">int</span> g <span style="color:#666">=</span> d <span style="color:#666">+</span> <span style="color:#666">4</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#00a000">mul</span>(j <span style="color:#666">+</span> e <span style="color:#666">+</span> f <span style="color:#666">+</span> g);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0b0;font-weight:bold">int</span> <span style="color:#00a000">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        <span style="color:#0b0;font-weight:bold">int</span> a <span style="color:#666">=</span> <span style="color:#666">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#0b0;font-weight:bold">int</span> b <span style="color:#666">=</span> <span style="color:#666">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#0b0;font-weight:bold">int</span> c <span style="color:#666">=</span> <span style="color:#666">2</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#0b0;font-weight:bold">int</span> d <span style="color:#666">=</span> <span style="color:#666">3</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#00a000">add</span>(a, b, c, d);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">return</span> a;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>í˜¸ì¶œ ì „/í›„ë¡œ ARM64 ì•„í‚¤í…ì²˜ì—ì„œì˜ Calling Conventionì„ í™•ì¸í•˜ê¸° í¸í•˜ë„ë¡ ìµœëŒ€í•œ ì½”ë“œë¥¼
í• ë‹¹ ì¤‘ì‹¬ìœ¼ë¡œ ì‘ì„±í•˜ì˜€ë‹¤. ìœ„ ì½”ë“œë¥¼ ì•„ë˜ì˜ ëª…ë ¹ì–´ë¡œ ì»´íŒŒì¼í•œ í›„ ë‹¤ì‹œ ì–´ì…ˆë¸”ë¦¬ë¡œ ë°”ê¿”ì£¼ì.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ aarch64-linux-gnu-gcc callstack.c     <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>        -fno-stack-protector            <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>        -fno-asynchronous-unwind-tables <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>        -fno-exceptions                 <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>        -fno-rtti -fverbose-asm         <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>        -o callstack.o
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ aarch64-linux-gnu-objdump -dS callstack.o &gt; callstack.disassemble
</span></span></code></pre></div><p>ìœ„ì™€ ê°™ì´ ì˜¤ë¸Œì íŠ¸ íŒŒì¼ì„ ë§Œë“¤ì—ˆë‹¤ê°€ ë‹¤ì‹œ dump í•˜ëŠ” ì´ìœ ëŠ” ë¶ˆí•„ìš”í•œ ì–´ì…ˆë¸”ë¦¬ ë ˆì´ë¸”ì„
ì—†ì• ê¸° ìœ„í•´ì„œë‹¤. ì‹¤ì œë¡œ gccì˜ -S ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ ë‹¨ìˆœí•˜ê²Œ ì–´ì…ˆë¸”ë¦¬ ì½”ë“œë¥¼ ë§Œë“¤ì–´ë‚´ë©´ ì›í•˜ëŠ”
ì–´ì…ˆ ì½”ë“œë¥¼ ì–»ê¸° í˜ë“¤ë‹¤. ì´ì œ ì–»ì–´ë‚¸ ì–´ì…ˆë¸”ë¦¬ ì½”ë“œë¥¼ ì‚´í´ë³´ì.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>0000000000000714 &lt;mul&gt;:
</span></span><span style="display:flex;"><span> 714:	d10043ff 	sub	sp, sp, #0x10
</span></span><span style="display:flex;"><span> 718:	b9000fe0 	str	w0, [sp, #12]
</span></span><span style="display:flex;"><span> 71c:	b9400fe0 	ldr	w0, [sp, #12]
</span></span><span style="display:flex;"><span> 720:	531f7800 	lsl	w0, w0, #1
</span></span><span style="display:flex;"><span> 724:	b9000fe0 	str	w0, [sp, #12]
</span></span><span style="display:flex;"><span> 728:	d503201f 	nop
</span></span><span style="display:flex;"><span> 72c:	910043ff 	add	sp, sp, #0x10
</span></span><span style="display:flex;"><span> 730:	d65f03c0 	ret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>0000000000000734 &lt;add&gt;:
</span></span><span style="display:flex;"><span> 734:	a9bd7bfd 	stp	x29, x30, [sp, #-48]!
</span></span><span style="display:flex;"><span> 738:	910003fd 	mov	x29, sp
</span></span><span style="display:flex;"><span> 73c:	b9001fe0 	str	w0, [sp, #28]
</span></span><span style="display:flex;"><span> 740:	b9001be1 	str	w1, [sp, #24]
</span></span><span style="display:flex;"><span> 744:	b90017e2 	str	w2, [sp, #20]
</span></span><span style="display:flex;"><span> 748:	b90013e3 	str	w3, [sp, #16]
</span></span><span style="display:flex;"><span> 74c:	b9401fe0 	ldr	w0, [sp, #28]
</span></span><span style="display:flex;"><span> 750:	11000400 	add	w0, w0, #0x1
</span></span><span style="display:flex;"><span> 754:	b9002fe0 	str	w0, [sp, #44]
</span></span><span style="display:flex;"><span> 758:	b9401be0 	ldr	w0, [sp, #24]
</span></span><span style="display:flex;"><span> 75c:	11000800 	add	w0, w0, #0x2
</span></span><span style="display:flex;"><span> 760:	b9002be0 	str	w0, [sp, #40]
</span></span><span style="display:flex;"><span> 764:	b94017e0 	ldr	w0, [sp, #20]
</span></span><span style="display:flex;"><span> 768:	11000c00 	add	w0, w0, #0x3
</span></span><span style="display:flex;"><span> 76c:	b90027e0 	str	w0, [sp, #36]
</span></span><span style="display:flex;"><span> 770:	b94013e0 	ldr	w0, [sp, #16]
</span></span><span style="display:flex;"><span> 774:	11001000 	add	w0, w0, #0x4
</span></span><span style="display:flex;"><span> 778:	b90023e0 	str	w0, [sp, #32]
</span></span><span style="display:flex;"><span> 77c:	b9402fe1 	ldr	w1, [sp, #44]
</span></span><span style="display:flex;"><span> 780:	b9402be0 	ldr	w0, [sp, #40]
</span></span><span style="display:flex;"><span> 784:	0b000021 	add	w1, w1, w0
</span></span><span style="display:flex;"><span> 788:	b94027e0 	ldr	w0, [sp, #36]
</span></span><span style="display:flex;"><span> 78c:	0b000021 	add	w1, w1, w0
</span></span><span style="display:flex;"><span> 790:	b94023e0 	ldr	w0, [sp, #32]
</span></span><span style="display:flex;"><span> 794:	0b000020 	add	w0, w1, w0
</span></span><span style="display:flex;"><span> 798:	97ffffdf 	bl	714 &lt;mul&gt;
</span></span><span style="display:flex;"><span> 79c:	d503201f 	nop
</span></span><span style="display:flex;"><span> 7a0:	a8c37bfd 	ldp	x29, x30, [sp], #48
</span></span><span style="display:flex;"><span> 7a4:	d65f03c0 	ret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>00000000000007a8 &lt;main&gt;:
</span></span><span style="display:flex;"><span> 7a8:	a9be7bfd 	stp	x29, x30, [sp, #-32]!
</span></span><span style="display:flex;"><span> 7ac:	910003fd 	mov	x29, sp
</span></span><span style="display:flex;"><span> 7b0:	b9001fff 	str	wzr, [sp, #28]
</span></span><span style="display:flex;"><span> 7b4:	52800020 	mov	w0, #0x1                   	// #1
</span></span><span style="display:flex;"><span> 7b8:	b9001be0 	str	w0, [sp, #24]
</span></span><span style="display:flex;"><span> 7bc:	52800040 	mov	w0, #0x2                   	// #2
</span></span><span style="display:flex;"><span> 7c0:	b90017e0 	str	w0, [sp, #20]
</span></span><span style="display:flex;"><span> 7c4:	52800060 	mov	w0, #0x3                   	// #3
</span></span><span style="display:flex;"><span> 7c8:	b90013e0 	str	w0, [sp, #16]
</span></span><span style="display:flex;"><span> 7cc:	b94013e3 	ldr	w3, [sp, #16]
</span></span><span style="display:flex;"><span> 7d0:	b94017e2 	ldr	w2, [sp, #20]
</span></span><span style="display:flex;"><span> 7d4:	b9401be1 	ldr	w1, [sp, #24]
</span></span><span style="display:flex;"><span> 7d8:	b9401fe0 	ldr	w0, [sp, #28]
</span></span><span style="display:flex;"><span> 7dc:	97ffffd6 	bl	734 &lt;add&gt;
</span></span><span style="display:flex;"><span> 7e0:	b9401fe0 	ldr	w0, [sp, #28]
</span></span><span style="display:flex;"><span> 7e4:	a8c27bfd 	ldp	x29, x30, [sp], #32
</span></span><span style="display:flex;"><span> 7e8:	d65f03c0 	ret
</span></span></code></pre></div><p>ì–´ì…ˆë¸”ë¦¬ ì½”ë“œë¥¼ ì‚´í´ë³´ë©´ main, add, mul í•¨ìˆ˜ê°€ í˜¸ì¶œë  ë•Œë§ˆë‹¤ ì²«ë²ˆì§¸ ë¼ì¸ì—ì„œ x29/x30 ê°’ì„
sp (ìŠ¤íƒ í¬ì¸í„°)ì— ì €ì¥í•˜ê³  Stack Frameì„ í™•ë³´í•˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤. x29ëŠ” Frame Pointer,
x30ì€ Link Registerë¡œì„œ ì‚¬ìš©ë˜ë©° ê°ê° ìŠ¤íƒ í”„ë ˆì„ì˜ base, Return Addressë¥¼ ê°–ê³  ìˆë‹¤ê³ 
ìƒê°í•˜ë©´ ëœë‹¤. add í•¨ìˆ˜ê°€ mul í•¨ìˆ˜ì—ì„œ ê°ê° stack frameì„ í™•ë³´í•˜ëŠ” ì–´ì…ˆë¸”ë¦¬ ëª…ë ¹ì–´ê°€
ë‹¤ë¥´ê²Œ ë‚˜ì™€ìˆë‹¤. add í•¨ìˆ˜ë¥¼ ë¨¼ì € ì‚´í´ë³´ë©´ ì•„ë˜ì™€ ê°™ë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>stp     x29, x30, [sp, #-48]!
</span></span></code></pre></div><p>ì´ëŠ” x29, x30 ê°’ì„ [sp]ì— ì €ì¥(spê°€ ê°–ê³  ìˆëŠ” ë©”ëª¨ë¦¬ ì£¼ì†Œì—)í•œ ë‹¤ìŒ spë¥¼ -48 ì˜¤í”„ì…‹ë§Œí¼
ì´ë™í•˜ë¼ëŠ” ëœ»ì´ë‹¤. ì´ ë•Œ, ìŠ¤íƒ í• ë‹¹ì€ ë©”ëª¨ë¦¬ ë°˜ëŒ€ ë°©í–¥ìœ¼ë¡œ í™•ë³´ë˜ëŠ” ì ì— ì£¼ëª©í•˜ì. mul í•¨ìˆ˜ëŠ”
ë³„ë„ì˜ ë°±ì—… ì—†ì´ ê³§ë°”ë¡œ ìŠ¤íƒ í”„ë ˆì„ì„ í™•ë³´í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.</p>
<p>ê³„ì†í•´ì„œ add í•¨ìˆ˜ë¥¼ ì‚´í´ë³´ë©´ ìŠ¤íƒ í”„ë ˆì„ì„ í™•ë³´í•œ í›„ int d, e, fì— í•´ë‹¹í•˜ëŠ” ì§€ì—­ ë³€ìˆ˜ë“¤ì„
ìŠ¤íƒì— ì €ì¥í•˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤. x29ëŠ” stack frame pointer, x30ì€ return addressë¥¼
ì €ì¥í•˜ê³  ìˆë‹¤.</p>
<p><p class="markdown-image">
  <img src="/img/stack-protector_figure_1.png" alt="Stack Layout without Stack Protector"  />
</p></p>
<h3 id="í™œì„±í™”-ì‹œì˜-ë ˆì´ì•„ì›ƒ">í™œì„±í™” ì‹œì˜ ë ˆì´ì•„ì›ƒ <a href="#%ed%99%9c%ec%84%b1%ed%99%94-%ec%8b%9c%ec%9d%98-%eb%a0%88%ec%9d%b4%ec%95%84%ec%9b%83" class="anchor">ğŸ”—</a></h3><p>ê·¸ë ‡ë‹¤ë©´ stack protectorê°€ í™œì„±í™”ëœ ë©”ëª¨ë¦¬ ë ˆì´ì•„ì›ƒì€ ì–´ë–»ê²Œ ë ê¹Œ? ì´ë²ˆì—ëŠ”
-fstack-protector-all ì˜µì…˜ì„ ì´ìš©í•˜ì—¬ ì–´ì…ˆë¸”ë¦¬ ì½”ë“œë¥¼ ìƒì„±í•´ì£¼ì.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>000000000000086c &lt;add&gt;:
</span></span><span style="display:flex;"><span> 86c:	a9bc7bfd 	stp	x29, x30, [sp, #-64]!
</span></span><span style="display:flex;"><span> 870:	910003fd 	mov	x29, sp
</span></span><span style="display:flex;"><span> 874:	b9001fe0 	str	w0, [sp, #28]
</span></span><span style="display:flex;"><span> 878:	b9001be1 	str	w1, [sp, #24]
</span></span><span style="display:flex;"><span> 87c:	b90017e2 	str	w2, [sp, #20]
</span></span><span style="display:flex;"><span> 880:	b90013e3 	str	w3, [sp, #16]
</span></span><span style="display:flex;"><span> 884:	90000080 	adrp	x0, 10000 &lt;__FRAME_END__+0xf520&gt;
</span></span><span style="display:flex;"><span> 888:	f947f400 	ldr	x0, [x0, #4072]
</span></span><span style="display:flex;"><span> 88c:	f9400001 	ldr	x1, [x0]
</span></span><span style="display:flex;"><span> 890:	f9001fe1 	str	x1, [sp, #56]
</span></span><span style="display:flex;"><span> 894:	d2800001 	mov	x1, #0x0                   	// #0
</span></span><span style="display:flex;"><span> 898:	b9401fe0 	ldr	w0, [sp, #28]
</span></span><span style="display:flex;"><span> 89c:	11000400 	add	w0, w0, #0x1
</span></span><span style="display:flex;"><span> 8a0:	b9002be0 	str	w0, [sp, #40]
</span></span><span style="display:flex;"><span> 8a4:	b9401be0 	ldr	w0, [sp, #24]
</span></span><span style="display:flex;"><span> 8a8:	11000800 	add	w0, w0, #0x2
</span></span><span style="display:flex;"><span> 8ac:	b9002fe0 	str	w0, [sp, #44]
</span></span><span style="display:flex;"><span> 8b0:	b94017e0 	ldr	w0, [sp, #20]
</span></span><span style="display:flex;"><span> 8b4:	11000c00 	add	w0, w0, #0x3
</span></span><span style="display:flex;"><span> 8b8:	b90033e0 	str	w0, [sp, #48]
</span></span><span style="display:flex;"><span> 8bc:	b94013e0 	ldr	w0, [sp, #16]
</span></span><span style="display:flex;"><span> 8c0:	11001000 	add	w0, w0, #0x4
</span></span><span style="display:flex;"><span> 8c4:	b90037e0 	str	w0, [sp, #52]
</span></span><span style="display:flex;"><span> 8c8:	b9402be1 	ldr	w1, [sp, #40]
</span></span><span style="display:flex;"><span> 8cc:	b9402fe0 	ldr	w0, [sp, #44]
</span></span><span style="display:flex;"><span> 8d0:	0b000021 	add	w1, w1, w0
</span></span><span style="display:flex;"><span> 8d4:	b94033e0 	ldr	w0, [sp, #48]
</span></span><span style="display:flex;"><span> 8d8:	0b000021 	add	w1, w1, w0
</span></span><span style="display:flex;"><span> 8dc:	b94037e0 	ldr	w0, [sp, #52]
</span></span><span style="display:flex;"><span> 8e0:	0b000020 	add	w0, w1, w0
</span></span><span style="display:flex;"><span> 8e4:	97ffffcc 	bl	814 &lt;mul&gt;
</span></span><span style="display:flex;"><span> 8e8:	d503201f 	nop
</span></span><span style="display:flex;"><span> 8ec:	90000080 	adrp	x0, 10000 &lt;__FRAME_END__+0xf520&gt;
</span></span><span style="display:flex;"><span> 8f0:	f947f400 	ldr	x0, [x0, #4072]
</span></span><span style="display:flex;"><span> 8f4:	f9401fe2 	ldr	x2, [sp, #56]
</span></span><span style="display:flex;"><span> 8f8:	f9400001 	ldr	x1, [x0]
</span></span><span style="display:flex;"><span> 8fc:	eb010042 	subs	x2, x2, x1
</span></span><span style="display:flex;"><span> 900:	d2800001 	mov	x1, #0x0                   	// #0
</span></span><span style="display:flex;"><span> 904:	54000040 	b.eq	90c &lt;add+0xa0&gt;  // b.none
</span></span><span style="display:flex;"><span> 908:	97ffff66 	bl	6a0 &lt;__stack_chk_fail@plt&gt;
</span></span><span style="display:flex;"><span> 90c:	a8c47bfd 	ldp	x29, x30, [sp], #64
</span></span><span style="display:flex;"><span> 910:	d65f03c0 	ret
</span></span></code></pre></div><p>ë³´ê¸°ì—ë„ ì´ì „ì— ì‚´í´ë´¤ë˜ add í•¨ìˆ˜ë³´ë‹¤ í›¨ì”¬ ì½”ë“œê°€ ê¸¸ì–´ì¡Œë‹¤. ì—¬ê¸°ì„œ ì¤‘ìš”í•œ ê±´ í•¨ìˆ˜ ì´ˆê¸°ì—
ìŠ¤íƒ í¬ì¸í„°ë¥¼ ì›€ì§ì¸ í›„ canary ì˜ì—­ì„ ìŠ¤íƒì— ì €ì¥í•˜ëŠ” ë¶€ë¶„ì´ë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span> 884:	90000080 	adrp	x0, 10000 &lt;__FRAME_END__+0xf520&gt;
</span></span><span style="display:flex;"><span> 888:	f947f400 	ldr	x0, [x0, #4072]
</span></span><span style="display:flex;"><span> 88c:	f9400001 	ldr	x1, [x0]
</span></span><span style="display:flex;"><span> 890:	f9001fe1 	str	x1, [sp, #56]
</span></span><span style="display:flex;"><span> ...
</span></span><span style="display:flex;"><span> 908:	97ffff66 	bl	6a0 &lt;__stack_chk_fail@plt&gt;
</span></span></code></pre></div><p><p class="markdown-image">
  <img src="/img/stack-protector_figure_2.png" alt="Stack Layout without Stack Protector"  />
</p></p>
<p>Stack Frame Pointerì™€ Link Register ì •ë³´ë¥¼ ìŠ¤íƒ í•˜ìœ„ì— ë‘ê³  ì¼ë°˜ì ìœ¼ë¡œëŠ” ê³§ë°”ë¡œ
ì§€ì—­ë³€ìˆ˜ë“¤ì´ ìœ„ì¹˜í•˜ì§€ë§Œ Stack Protector ë¥¼ í™œì„±í™”í•˜ë©´ ì´ ì˜ì—­ì´ canary ì˜ì—­ìœ¼ë¡œ ì±„ì›Œì§€ëŠ”
ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.</p>
<h2 id="stack-smashing-ì—ëŸ¬ê°€-ì•ˆë‚œë‹¤-canary-boundary">Stack Smashing ì—ëŸ¬ê°€ ì•ˆë‚œë‹¤? Canary Boundary <a href="#stack-smashing-%ec%97%90%eb%9f%ac%ea%b0%80-%ec%95%88%eb%82%9c%eb%8b%a4-canary-boundary" class="anchor">ğŸ”—</a></h2><p>ARM Reference ë¬¸ì„œì— ë‚˜ì™€ìˆëŠ” ì˜ˆì œ
(<a href="https://developer.arm.com/documentation/101754/0616/armclang-Reference/armclang-Command-line-Options/-fstack-protector---fstack-protector-all---fstack-protector-strong---fno-stack-protector" target="_blank" rel="noopener">https://developer.arm.com/documentation/101754/0616/armclang-Reference/armclang-Command-line-Options/-fstack-protector---fstack-protector-all---fstack-protector-strong---fno-stack-protector</a>)
ë¡œ ì§ì ‘ í™•ì¸í•´ë³´ë ¤ í–ˆì§€ë§Œ ì˜ë„ëœëŒ€ë¡œ ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ ì•Šì•˜ë‹¤. ì´ì— ì§ì ‘ GDB ë¥¼ ì´ìš©í•˜ì—¬ ë””ë²„ê¹…ì„
í•´ë³´ë‹ˆ ì•„ë˜ì™€ ê°™ì´ fs:0x28, ì¦‰ canary valueì˜ í•˜ìœ„ 8ë¹„íŠ¸ê°€ 0ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì–´ ìˆì—ˆë‹¤.</p>
<p><p class="markdown-image">
  <img src="/img/stack-protector_figure_3.png" alt="Stack Layout without Stack Protector"  />
</p></p>
<p>fs, gs ë ˆì§€ìŠ¤í„°ëŠ” íŠ¹ë³„í•œ ìš´ì˜ì²´ì œì˜ ìë£Œêµ¬ì¡°ì— ì ‘ê·¼í•˜ê¸° ìœ„í•œ ê²ƒì´ë‹¤. íŠ¹íˆ, FS:0x28ì€
ë¦¬ëˆ…ìŠ¤ì—ì„œ stack-guard ê°’ì„ ì €ì¥í•˜ê³  stack-guard check ë£¨í‹´ì—ì„œ ì‚¬ìš©ëœë‹¤.
(<a href="https://stackoverflow.com/questions/10325713/why-does-this-memory-address-fs0x28-fs0x28-have-a-random-value" target="_blank" rel="noopener">https://stackoverflow.com/questions/10325713/why-does-this-memory-address-fs0x28-fs0x28-have-a-random-value</a>)
ê·¸ëŸ°ë° fs:0x28 ê°’ì´ ì²˜ìŒë¶€í„° í•˜ìœ„ 1ë°”ì´íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì–´ ìˆë‹¤ëŠ” ê²ƒì€ ì»¤ë„ ìª½ ì½”ë“œì— ì˜í•œ ê²ƒì´ë¼ê³ 
ìƒê°í•˜ê³  ì‚´í´ë³´ë‹ˆ, ì»¤ë„ include/linux/random.h íŒŒì¼ì— ì•„ë˜ì˜ ì½”ë“œê°€ ìˆì—ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#080;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"> * On 64-bit architectures, protect against non-terminated C string overflows
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"> * by zeroing out the first byte of the canary; this leaves 56 bits of entropy.
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#080">#ifdef CONFIG_64BIT
</span></span></span><span style="display:flex;"><span><span style="color:#080"># ifdef __LITTLE_ENDIAN
</span></span></span><span style="display:flex;"><span><span style="color:#080">#  define CANARY_MASK 0xffffffffffffff00UL
</span></span></span><span style="display:flex;"><span><span style="color:#080"># else </span><span style="color:#080;font-style:italic">/* big endian, 64 bits: */</span><span style="color:#080">
</span></span></span><span style="display:flex;"><span><span style="color:#080">#  define CANARY_MASK 0x00ffffffffffffffUL
</span></span></span><span style="display:flex;"><span><span style="color:#080"># endif
</span></span></span><span style="display:flex;"><span><span style="color:#080">#else </span><span style="color:#080;font-style:italic">/* 32 bits: */</span><span style="color:#080">
</span></span></span><span style="display:flex;"><span><span style="color:#080"># define CANARY_MASK 0xffffffffUL
</span></span></span><span style="display:flex;"><span><span style="color:#080">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#080"></span>
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">static</span> <span style="color:#a2f;font-weight:bold">inline</span> <span style="color:#0b0;font-weight:bold">unsigned</span> <span style="color:#0b0;font-weight:bold">long</span> <span style="color:#00a000">get_random_canary</span>(<span style="color:#0b0;font-weight:bold">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#0b0;font-weight:bold">unsigned</span> <span style="color:#0b0;font-weight:bold">long</span> val <span style="color:#666">=</span> <span style="color:#00a000">get_random_long</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a2f;font-weight:bold">return</span> val <span style="color:#666">&amp;</span> CANARY_MASK;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ì²˜ìŒì—ëŠ” êµ³ì´ ì´ë ‡ê²Œ NULLì„ ì²˜ë¦¬í•´ì•¼ í•˜ë‚˜ ì‹¶ì—ˆëŠ”ë° ë¸”ë¼ì¸ë“œë¥¼ í†µí•´ ì•Œê²Œëœ ì‚¬ì‹¤ì€ canary
valueë¥¼ ë°”ë¡œ ì¶œë ¥í•˜ì§€ ëª»í•˜ë„ë¡ NULL ë¬¸ìë¥¼ ì´ìš©í•´ boundaryë¥¼ ìƒì„±í•˜ê¸° ìœ„í•œ ìš©ë„ë¼ëŠ” ê²ƒì„
ì•Œê²Œëë‹¤. ì´ë¡œì¨ stack protectorê°€ ìŠ¤íƒì—ì„œ ì–´ë–»ê²Œ ìœ„ì¹˜í•˜ëŠ”ì§€, ê·¸ë¦¬ê³  ì™œ ARM ë ˆí¼ëŸ°ìŠ¤ ë¬¸ì„œì—
ìˆëŠ” ì˜ˆì œê°€ ë™ì‘ì„ í•˜ì§€ ì•ŠëŠ”ì§€, canary boundary ê°’ì´ ì™œ NULLë¡œ ë˜ì–´ìˆëŠ”ì§€ ë“±ì„ ì•Œ ìˆ˜ ìˆì—ˆë‹¤.</p>
<h2 id="ì°¸ê³ -ìë£Œ">ì°¸ê³  ìë£Œ <a href="#%ec%b0%b8%ea%b3%a0-%ec%9e%90%eb%a3%8c" class="anchor">ğŸ”—</a></h2><ul>
<li><a href="https://stackoverflow.com/questions/10325713/why-does-this-memory-address-fs0x28-fs0x28-have-a-random-value" target="_blank" rel="noopener">FS/GS ë ˆì§€ìŠ¤í„° in Stackoverflow</a></li>
<li><a href="https://wolchok.org/posts/how-to-read-arm64-assembly-language/" target="_blank" rel="noopener">stp ë ˆì§€ìŠ¤í„° ì‚¬ìš© ì˜ˆ</a></li>
<li><a href="https://www.cs.princeton.edu/courses/archive/spr19/cos217/lectures/15_AssemblyFunctions.pdf" target="_blank" rel="noopener">ARM ì–´ì…ˆë¸”ë¦¬ ê°•ì¢Œ ìë£Œ - Function Calls</a></li>
<li><a href="https://thinkingeek.com/2017/05/29/exploring-aarch64-assembler-chapter-8/" target="_blank" rel="noopener">ARM64 ìŠ¤íƒ ë¶„ì„ ìë£Œ</a></li>
<li><a href="https://stackoverflow.com/questions/38552116/how-to-remove-noise-from-gcc-clang-assembly-output" target="_blank" rel="noopener">GCC ì–´ì…ˆë¸”ë¦¬ strip ë°©ë²• #1</a></li>
<li><a href="https://stackoverflow.com/questions/2529185/what-are-cfi-directives-in-gnu-assembler-gas-used-for" target="_blank" rel="noopener">GCC ì–´ì…ˆë¸”ë¦¬ strip ë°©ë²• #2</a></li>
</ul>

    </div>

    
        <div class="tags">
            
                <a href="https://seokbeomkim.github.io/tags/ssp">ssp</a>
            
                <a href="https://seokbeomkim.github.io/tags/stack">stack</a>
            
                <a href="https://seokbeomkim.github.io/tags/canary">canary</a>
            
        </div>
    
    
    

</section>


    </main>
    
    <footer id="footer">
    

    <div class="copyright">
    
        Copyright - Sukbeom Kim
    
    </div>

    
</footer>



  </body>
</html>
