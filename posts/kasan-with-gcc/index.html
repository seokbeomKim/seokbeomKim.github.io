<!doctype html>
<html
  lang="en-us"
  dir="ltr"
>
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
<meta name="language" content="en" />
<meta name="viewport" content="width=device-width" />
<title>
    커널의 KASAN 코드가 삽입되는 방법 | 평범한 개발자
</title>
  <meta name="description" content="커널의 KASAN 코드가 삽입되는 방법 Generic KASAN 의 경우, 위와 같이 __asan_load와 __asan_store 함수가 정의되어 있다. 단순하게 KASAN의 사용법만 보았을 때, 과연 커널에서 어떻게 모든 메모리에 접근할 때마다 특정 함수의 내용을 실행할까 라는 궁금증이 생겼다. 커널 문서에 따르면, 컴파일러에 의해 위 함수들이 인라인 형태로 모든 메모리 접근 전에 삽입되어 해당 메모리가 안전한지 확인한다고 기술하고 있다. 이에 처음에는 static inline 형태로 정의된 함수가 컴파일러에 의해 처리되는 것인가? 라고 생각했다. 하지만, 실제 코드를 보았을 때 함수와 EXPORT_SYMBOL 이 사용된 것 외에는 그 어디에도 inline 키워드는 사용도지 않았다." />
<meta property="og:url" content="http://localhost:1313/posts/kasan-with-gcc/">
  <meta property="og:site_name" content="평범한 개발자">
  <meta property="og:title" content="커널의 KASAN 코드가 삽입되는 방법">
  <meta property="og:description" content="커널의 KASAN 코드가 삽입되는 방법 Generic KASAN 의 경우, 위와 같이 __asan_load와 __asan_store 함수가 정의되어 있다. 단순하게 KASAN의 사용법만 보았을 때, 과연 커널에서 어떻게 모든 메모리에 접근할 때마다 특정 함수의 내용을 실행할까 라는 궁금증이 생겼다. 커널 문서에 따르면, 컴파일러에 의해 위 함수들이 인라인 형태로 모든 메모리 접근 전에 삽입되어 해당 메모리가 안전한지 확인한다고 기술하고 있다. 이에 처음에는 static inline 형태로 정의된 함수가 컴파일러에 의해 처리되는 것인가? 라고 생각했다. 하지만, 실제 코드를 보았을 때 함수와 EXPORT_SYMBOL 이 사용된 것 외에는 그 어디에도 inline 키워드는 사용도지 않았다.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-09-24T01:13:41+09:00">
    <meta property="article:modified_time" content="2021-09-24T01:13:41+09:00">
    <meta property="article:tag" content="Kasan">
    <meta property="article:tag" content="Gcc">


  <meta itemprop="name" content="커널의 KASAN 코드가 삽입되는 방법">
  <meta itemprop="description" content="커널의 KASAN 코드가 삽입되는 방법 Generic KASAN 의 경우, 위와 같이 __asan_load와 __asan_store 함수가 정의되어 있다. 단순하게 KASAN의 사용법만 보았을 때, 과연 커널에서 어떻게 모든 메모리에 접근할 때마다 특정 함수의 내용을 실행할까 라는 궁금증이 생겼다. 커널 문서에 따르면, 컴파일러에 의해 위 함수들이 인라인 형태로 모든 메모리 접근 전에 삽입되어 해당 메모리가 안전한지 확인한다고 기술하고 있다. 이에 처음에는 static inline 형태로 정의된 함수가 컴파일러에 의해 처리되는 것인가? 라고 생각했다. 하지만, 실제 코드를 보았을 때 함수와 EXPORT_SYMBOL 이 사용된 것 외에는 그 어디에도 inline 키워드는 사용도지 않았다.">
  <meta itemprop="datePublished" content="2021-09-24T01:13:41+09:00">
  <meta itemprop="dateModified" content="2021-09-24T01:13:41+09:00">
  <meta itemprop="wordCount" content="402">
  <meta itemprop="keywords" content="Kasan,Gcc">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="커널의 KASAN 코드가 삽입되는 방법">
  <meta name="twitter:description" content="커널의 KASAN 코드가 삽입되는 방법 Generic KASAN 의 경우, 위와 같이 __asan_load와 __asan_store 함수가 정의되어 있다. 단순하게 KASAN의 사용법만 보았을 때, 과연 커널에서 어떻게 모든 메모리에 접근할 때마다 특정 함수의 내용을 실행할까 라는 궁금증이 생겼다. 커널 문서에 따르면, 컴파일러에 의해 위 함수들이 인라인 형태로 모든 메모리 접근 전에 삽입되어 해당 메모리가 안전한지 확인한다고 기술하고 있다. 이에 처음에는 static inline 형태로 정의된 함수가 컴파일러에 의해 처리되는 것인가? 라고 생각했다. 하지만, 실제 코드를 보았을 때 함수와 EXPORT_SYMBOL 이 사용된 것 외에는 그 어디에도 inline 키워드는 사용도지 않았다.">

<link rel="canonical" href="http://localhost:1313/posts/kasan-with-gcc/" />

    <link rel="stylesheet" href="/css/index.css" />


      <script src="/js/main.js" defer></script>
  
  



<script type="application/ld+json">
{
  "@context": "https://schema.org/",
  "@id": "http://localhost:1313/posts/kasan-with-gcc/",
  "@type": "BlogPosting",
  "articleSection": [
    "Kernel"
  ],
  "author": {
    "@type": "Person",
    "email": "sukbeom.kim@gmail.com",
    "name": "Sukbeom Kim",
    "url": "http://localhost:1313/about/"
  },
  "copyrightNotice": "Sukbeom Kim",
  "datePublished": "2021-09-24",
  "description": "커널의 KASAN 코드가 삽입되는 방법 Generic KASAN 의 경우, 위와 같이 __asan_load와 __asan_store 함수가 정의되어 있다. 단순하게 KASAN의 사용법만 보았을 때, 과연 커널에서 어떻게 모든 메모리에 접근할 때마다 특정 함수의 내용을 실행할까 라는 궁금증이 생겼다. 커널 문서에 따르면, 컴파일러에 의해 위 함수들이 인라인 형태로 모든 메모리 접근 전에 삽입되어 해당 메모리가 안전한지 확인한다고 기술하고 있다. 이에 처음에는 static inline 형태로 정의된 함수가 컴파일러에 의해 처리되는 것인가? 라고 생각했다. 하지만, 실제 코드를 보았을 때 함수와 EXPORT_SYMBOL 이 사용된 것 외에는 그 어디에도 inline 키워드는 사용도지 않았다.",
  "headline": "커널의 KASAN 코드가 삽입되는 방법",
  "isPartOf": {
    "@id": "http://localhost:1313/posts/",
    "@type": "Blog",
    "name": "Posts"
  },
  "keywords": [
    "Gcc",
    "Kasan"
  ],
  "mainEntityOfPage": "http://localhost:1313/posts/kasan-with-gcc/",
  "name": "커널의 KASAN 코드가 삽입되는 방법",
  "timeRequired": "PT2M",
  "url": "http://localhost:1313/posts/kasan-with-gcc/",
  "wordCount": 402
}
</script>


  </head>
  <body>
    <div class="container mx-auto flex max-w-prose flex-col space-y-10 p-4 md:p-6">
      <header class="flex flex-row items-center justify-between">
        <div>
  <a id="skip-nav" class="sr-only" href="#maincontent">Skip to main content</a>
  <a class="font-semibold" href="/">평범한 개발자</a>
</div>

  <nav>
    <ul class="flex flex-row items-center justify-end space-x-4">
    <li>
      <a aria-current="true" class="ancestor" href="/posts/">Posts</a
      >
    </li>
    <li>
      <a href="/graph/">Graph</a
      >
    </li>
    <li>
      <a href="/about/">About</a
      >
    </li>
    </ul>
  </nav>


      </header>
      <main class="prose prose-slate relative md:prose-lg prose-h1:text-[2em]" id="maincontent">
        <article class="main">
    <header>
      <h1 class="!mb-1">커널의 KASAN 코드가 삽입되는 방법</h1><div class="flex flex-row items-center space-x-4">
          <time class="text-sm italic opacity-80" datetime="2021-09-24T01:13:41&#43;09:00"
            >September 24, 2021</time
          >
        </div>
    </header>

    <h2 id="커널의-kasan-코드가-삽입되는-방법" class="scroll-mt-8 group">
  커널의 KASAN 코드가 삽입되는 방법
  
    <a href="#%ec%bb%a4%eb%84%90%ec%9d%98-kasan-%ec%bd%94%eb%93%9c%ea%b0%80-%ec%82%bd%ec%9e%85%eb%90%98%eb%8a%94-%eb%b0%a9%eb%b2%95"
        class="no-underline hidden opacity-50 hover:opacity-100 !text-inherit group-hover:inline-block"
        aria-hidden="true" title="Link to this heading" tabindex="-1">
        <svg
  xmlns="http://www.w3.org/2000/svg"
  width="16"
  height="16"
  fill="none"
  stroke="currentColor"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  class="lucide lucide-link w-4 h-4 block"
  viewBox="0 0 24 24"
>
  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
</svg>

    </a>
  
</h2>
<p>Generic KASAN 의 경우, 위와 같이 <code>__asan_load</code>와 <code>__asan_store</code> 함수가 정의되어
있다. 단순하게 KASAN의 사용법만 보았을 때, 과연 커널에서 어떻게 모든 메모리에
접근할 때마다 특정 함수의 내용을 실행할까 라는 궁금증이 생겼다. 커널 문서에
따르면, 컴파일러에 의해 위 함수들이 인라인 형태로 모든 메모리 접근 전에 삽입되어
해당 메모리가 안전한지 확인한다고 기술하고 있다. 이에 처음에는 <code>static inline</code>
형태로 정의된 함수가 컴파일러에 의해 처리되는 것인가? 라고 생각했다. 하지만,
실제 코드를 보았을 때 함수와 <code>EXPORT_SYMBOL</code> 이 사용된 것 외에는 그 어디에도
inline 키워드는 사용도지 않았다. 컴파일러가 해당 코드를 삽입한다고 하는데
정확하게 어떻게 삽입하는지, 해당 함수들의 이름이 바뀌면 어떤 결과가 나올지
궁금했다. 또한 커널 소스를 다 뒤져봐도 ASAN에 관련된 호출 부분을 아무리 찾아도
어떤 방식으로 <code>__asan_loadN</code>, <code>__asan_storeN</code> 이 메모리 접근 전에 삽입되는지
찾을 수 없었다.</p>
<p>KASAN 지원 여부가 컴파일러 버전에 따라 달라지는 것을 확인하고, 이에 컴파일러가
관련된 코드를 삽입하는 것을 직접 확인하기 위해 GCC 코드를 살펴보았다.</p>
<h2 id="gcc-코드" class="scroll-mt-8 group">
  GCC 코드
  
    <a href="#gcc-%ec%bd%94%eb%93%9c"
        class="no-underline hidden opacity-50 hover:opacity-100 !text-inherit group-hover:inline-block"
        aria-hidden="true" title="Link to this heading" tabindex="-1">
        <svg
  xmlns="http://www.w3.org/2000/svg"
  width="16"
  height="16"
  fill="none"
  stroke="currentColor"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  class="lucide lucide-link w-4 h-4 block"
  viewBox="0 0 24 24"
>
  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
</svg>

    </a>
  
</h2>
<p>GCC 코드(<code>$gcc_root/gcc/sanitizer.def</code>)에는 커널에서 _<em>asan</em>* 형태로 정의해놓은
심볼에 대해 <code>DEF_SANITIZER_BUILTIN</code> 이라는 매크로와 함께 아래와 같이
정의해놓았다.</p>
<figure class="codeblock not-prose relative scroll-mt-8" id="codeblock-01">
  <aside
    class="absolute right-0 top-0 hidden rounded-bl-sm rounded-tr-sm bg-white/10 px-2 py-1 text-white/70 transition-opacity md:inline-block"
  >
    <div class="codeblock-meta flex max-w-xs flex-row items-center space-x-3">
      <div class="small-caps shrink cursor-default truncate font-mono text-xs" aria-hidden="true">
        <span class="relative">c</span>
      </div>
      <div>
        <clipboard-copy
          type="button"
          aria-label="Copy code to clipboard"
          title="Copy code to clipboard"
          class="block cursor-pointer transition-colors hover:text-sky-400"
          target="#codeblock-01 code"
        >
          <svg
  xmlns="http://www.w3.org/2000/svg"
  fill="none"
  stroke="currentColor"
  stroke-width="2"
  stroke-linecap="round"
  stroke-linejoin="round"
  class="lucide lucide-clipboard h-4 w-4"
  viewBox="0 0 24 24"
>
  <rect width="8" height="4" x="8" y="2" rx="1" ry="1" />
  <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
</svg>

        </clipboard-copy>
      </div>
      <div>
        <a
          href="#codeblock-01"
          class="block"
          aria-label="Link to this code block"
          title="Link to this code block"
        >
          <svg
  xmlns="http://www.w3.org/2000/svg"
  width="16"
  height="16"
  fill="none"
  stroke="currentColor"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  class="lucide lucide-link w-4 h-4 block"
  viewBox="0 0 24 24"
>
  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
</svg>

        </a>
      </div>
    </div>
  </aside>
  <p class="sr-only">c code snippet start</p>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">DEF_SANITIZER_BUILTIN</span><span class="p">(</span><span class="n">BUILT_IN_ASAN_LOAD1</span><span class="p">,</span> <span class="s">&#34;__asan_load1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		      <span class="n">BT_FN_VOID_PTR</span><span class="p">,</span> <span class="n">ATTR_TMPURE_NOTHROW_LEAF_LIST</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">DEF_SANITIZER_BUILTIN</span><span class="p">(</span><span class="n">BUILT_IN_ASAN_LOAD2</span><span class="p">,</span> <span class="s">&#34;__asan_load2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		      <span class="n">BT_FN_VOID_PTR</span><span class="p">,</span> <span class="n">ATTR_TMPURE_NOTHROW_LEAF_LIST</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">DEF_SANITIZER_BUILTIN</span><span class="p">(</span><span class="n">BUILT_IN_ASAN_LOAD4</span><span class="p">,</span> <span class="s">&#34;__asan_load4&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		      <span class="n">BT_FN_VOID_PTR</span><span class="p">,</span> <span class="n">ATTR_TMPURE_NOTHROW_LEAF_LIST</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">DEF_SANITIZER_BUILTIN</span><span class="p">(</span><span class="n">BUILT_IN_ASAN_LOAD8</span><span class="p">,</span> <span class="s">&#34;__asan_load8&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		      <span class="n">BT_FN_VOID_PTR</span><span class="p">,</span> <span class="n">ATTR_TMPURE_NOTHROW_LEAF_LIST</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">DEF_SANITIZER_BUILTIN</span><span class="p">(</span><span class="n">BUILT_IN_ASAN_LOAD16</span><span class="p">,</span> <span class="s">&#34;__asan_load16&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		      <span class="n">BT_FN_VOID_PTR</span><span class="p">,</span> <span class="n">ATTR_TMPURE_NOTHROW_LEAF_LIST</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">DEF_SANITIZER_BUILTIN</span><span class="p">(</span><span class="n">BUILT_IN_ASAN_LOADN</span><span class="p">,</span> <span class="s">&#34;__asan_loadN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		      <span class="n">BT_FN_VOID_PTR_PTRMODE</span><span class="p">,</span> <span class="n">ATTR_TMPURE_NOTHROW_LEAF_LIST</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">DEF_SANITIZER_BUILTIN</span><span class="p">(</span><span class="n">BUILT_IN_ASAN_STORE1</span><span class="p">,</span> <span class="s">&#34;__asan_store1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		      <span class="n">BT_FN_VOID_PTR</span><span class="p">,</span> <span class="n">ATTR_TMPURE_NOTHROW_LEAF_LIST</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">DEF_SANITIZER_BUILTIN</span><span class="p">(</span><span class="n">BUILT_IN_ASAN_STORE2</span><span class="p">,</span> <span class="s">&#34;__asan_store2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		      <span class="n">BT_FN_VOID_PTR</span><span class="p">,</span> <span class="n">ATTR_TMPURE_NOTHROW_LEAF_LIST</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">DEF_SANITIZER_BUILTIN</span><span class="p">(</span><span class="n">BUILT_IN_ASAN_STORE4</span><span class="p">,</span> <span class="s">&#34;__asan_store4&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		      <span class="n">BT_FN_VOID_PTR</span><span class="p">,</span> <span class="n">ATTR_TMPURE_NOTHROW_LEAF_LIST</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">DEF_SANITIZER_BUILTIN</span><span class="p">(</span><span class="n">BUILT_IN_ASAN_STORE8</span><span class="p">,</span> <span class="s">&#34;__asan_store8&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		      <span class="n">BT_FN_VOID_PTR</span><span class="p">,</span> <span class="n">ATTR_TMPURE_NOTHROW_LEAF_LIST</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">DEF_SANITIZER_BUILTIN</span><span class="p">(</span><span class="n">BUILT_IN_ASAN_STORE16</span><span class="p">,</span> <span class="s">&#34;__asan_store16&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		      <span class="n">BT_FN_VOID_PTR</span><span class="p">,</span> <span class="n">ATTR_TMPURE_NOTHROW_LEAF_LIST</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">DEF_SANITIZER_BUILTIN</span><span class="p">(</span><span class="n">BUILT_IN_ASAN_STOREN</span><span class="p">,</span> <span class="s">&#34;__asan_storeN&#34;</span><span class="p">,</span></span></span></code></pre></div>
  <p class="sr-only">c code snippet end</p>

  
</figure>
<p>정의된 SANITIZER 중에서 BUILT_IN_ASAN_LOAD1 을 따라가보면,
<code>gcc_root/gcc/sanopt.c</code> 경로에 <code>pass_sanopt::execute</code> 메서드로 아래와 같이 enum
형태로 정의되어 있다. 호출 스택은 <code>pass_sanopt::execute</code> →
<code>asan_expand_check_ifn</code> → <code>check_func</code> 으로 구성된다.</p>
<figure class="codeblock not-prose relative scroll-mt-8" id="codeblock-02">
  <aside
    class="absolute right-0 top-0 hidden rounded-bl-sm rounded-tr-sm bg-white/10 px-2 py-1 text-white/70 transition-opacity md:inline-block"
  >
    <div class="codeblock-meta flex max-w-xs flex-row items-center space-x-3">
      <div class="small-caps shrink cursor-default truncate font-mono text-xs" aria-hidden="true">
        <span class="relative">c</span>
      </div>
      <div>
        <clipboard-copy
          type="button"
          aria-label="Copy code to clipboard"
          title="Copy code to clipboard"
          class="block cursor-pointer transition-colors hover:text-sky-400"
          target="#codeblock-02 code"
        >
          <svg
  xmlns="http://www.w3.org/2000/svg"
  fill="none"
  stroke="currentColor"
  stroke-width="2"
  stroke-linecap="round"
  stroke-linejoin="round"
  class="lucide lucide-clipboard h-4 w-4"
  viewBox="0 0 24 24"
>
  <rect width="8" height="4" x="8" y="2" rx="1" ry="1" />
  <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
</svg>

        </clipboard-copy>
      </div>
      <div>
        <a
          href="#codeblock-02"
          class="block"
          aria-label="Link to this code block"
          title="Link to this code block"
        >
          <svg
  xmlns="http://www.w3.org/2000/svg"
  width="16"
  height="16"
  fill="none"
  stroke="currentColor"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  class="lucide lucide-link w-4 h-4 block"
  viewBox="0 0 24 24"
>
  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
</svg>

        </a>
      </div>
    </div>
  </aside>
  <p class="sr-only">c code snippet start</p>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="n">tree</span>
</span></span><span class="line"><span class="cl"><span class="nf">check_func</span> <span class="p">(</span><span class="kt">bool</span> <span class="n">is_store</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">recover_p</span><span class="p">,</span> <span class="n">HOST_WIDE_INT</span> <span class="n">size_in_bytes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="kt">int</span> <span class="o">*</span><span class="n">nargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="k">enum</span> <span class="n">built_in_function</span> <span class="n">check</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="o">=</span> <span class="p">{</span> <span class="p">{</span> <span class="p">{</span> <span class="n">BUILT_IN_ASAN_LOAD1</span><span class="p">,</span> <span class="n">BUILT_IN_ASAN_LOAD2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="n">BUILT_IN_ASAN_LOAD4</span><span class="p">,</span> <span class="n">BUILT_IN_ASAN_LOAD8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="n">BUILT_IN_ASAN_LOAD16</span><span class="p">,</span> <span class="n">BUILT_IN_ASAN_LOADN</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">	  <span class="p">{</span> <span class="n">BUILT_IN_ASAN_STORE1</span><span class="p">,</span> <span class="n">BUILT_IN_ASAN_STORE2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="n">BUILT_IN_ASAN_STORE4</span><span class="p">,</span> <span class="n">BUILT_IN_ASAN_STORE8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="n">BUILT_IN_ASAN_STORE16</span><span class="p">,</span> <span class="n">BUILT_IN_ASAN_STOREN</span> <span class="p">}</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span> <span class="p">{</span> <span class="n">BUILT_IN_ASAN_LOAD1_NOABORT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="n">BUILT_IN_ASAN_LOAD2_NOABORT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="n">BUILT_IN_ASAN_LOAD4_NOABORT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="n">BUILT_IN_ASAN_LOAD8_NOABORT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="n">BUILT_IN_ASAN_LOAD16_NOABORT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="n">BUILT_IN_ASAN_LOADN_NOABORT</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">	  <span class="p">{</span> <span class="n">BUILT_IN_ASAN_STORE1_NOABORT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="n">BUILT_IN_ASAN_STORE2_NOABORT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="n">BUILT_IN_ASAN_STORE4_NOABORT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="n">BUILT_IN_ASAN_STORE8_NOABORT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="n">BUILT_IN_ASAN_STORE16_NOABORT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="n">BUILT_IN_ASAN_STOREN_NOABORT</span> <span class="p">}</span> <span class="p">}</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">size_in_bytes</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="n">nargs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nf">builtin_decl_implicit</span> <span class="p">(</span><span class="n">check</span><span class="p">[</span><span class="n">recover_p</span><span class="p">][</span><span class="n">is_store</span><span class="p">][</span><span class="mi">5</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">nargs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">size_log2</span> <span class="o">=</span> <span class="nf">exact_log2</span> <span class="p">(</span><span class="n">size_in_bytes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">builtin_decl_implicit</span> <span class="p">(</span><span class="n">check</span><span class="p">[</span><span class="n">recover_p</span><span class="p">][</span><span class="n">is_store</span><span class="p">][</span><span class="n">size_log2</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
  <p class="sr-only">c code snippet end</p>

  
</figure>
<p>GCC 코드에서 Optimize and expand sanitizer functions 라고 기술되어 있는 위의
<code>$gcc_root/gcc/sanopt.c</code> 파일를 살펴보고 난 뒤, 커널 코드 내에서 별도의 호출
없이 어떻게 &ldquo;모든&rdquo; 메모리 접근에 대해 유효성 확인을 하는 코드를 삽입할 수
있는지, Generic KASAN에 관련된 함수들이 실제로 메모리 접근 전 어떻게 inline
형태로 추가되는지 대략적으로 이해할 수 있었다.</p>
<p>결론은 Memory Sanitizer 연관 함수들은 커널에서 정의하였지만 해당 함수들이 실제로
메모리 접근 전에 인라인 또는 아웃라인으로 삽입/호출되는 부분은 컴파일러가 그
역할을 담당한다.</p>

  </article>
    <aside class="not-prose flex flex-col space-y-8 border-t pt-6">
    <section class="flex flex-col space-y-4">
      <h2 class="flex flex-row items-center space-x-2 text-lg font-semibold">
        <svg
  xmlns="http://www.w3.org/2000/svg"
  fill="none"
  stroke="currentColor"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  class="lucide lucide-shapes h-4 w-4"
  viewBox="0 0 24 24"
  aria-hidden="true"
>
  <path
    d="M8.3 10a.7.7 0 0 1-.626-1.079L11.4 3a.7.7 0 0 1 1.198-.043L16.3 8.9a.7.7 0 0 1-.572 1.1Z"
  />
  <rect width="7" height="7" x="3" y="14" rx="1" />
  <circle cx="17.5" cy="17.5" r="3.5" />
</svg>

        <span>Categories</span>
      </h2>

      <ul class="ml-6 flex flex-row flex-wrap items-center space-x-2">
          <li>
            <a href="/categories/kernel/" class="taxonomy category">Kernel</a>
          </li>
      </ul>
    </section>
    <section class="flex flex-col space-y-4">
      <h2 class="flex flex-row items-center space-x-2 text-lg font-semibold">
        <svg
  xmlns="http://www.w3.org/2000/svg"
  fill="none"
  stroke="currentColor"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  class="lucide lucide-tags h-4 w-4"
  viewBox="0 0 24 24"
  aria-hidden="true"
>
  <path d="m15 5 6.3 6.3a2.4 2.4 0 0 1 0 3.4L17 19" />
  <path
    d="M9.586 5.586A2 2 0 0 0 8.172 5H3a1 1 0 0 0-1 1v5.172a2 2 0 0 0 .586 1.414L8.29 18.29a2.426 2.426 0 0 0 3.42 0l3.58-3.58a2.426 2.426 0 0 0 0-3.42z"
  />
  <circle cx="6.5" cy="9.5" r=".5" fill="currentColor" />
</svg>

        <span>Tags</span>
      </h2>

      <ul class="not-prose ml-6 flex flex-row flex-wrap items-center space-x-2">
          <li>
            <a href="/tags/kasan/" class="taxonomy tag">kasan</a>
          </li>
          <li>
            <a href="/tags/gcc/" class="taxonomy tag">gcc</a>
          </li>
      </ul>
    </section>
    <section class="flex flex-col space-y-4" aria-hidden="true">
      <h2 class="flex flex-row items-center space-x-2 text-lg font-semibold">
        <svg
  xmlns="http://www.w3.org/2000/svg"
  fill="none"
  stroke="currentColor"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  class="lucide lucide-chart-network h-4 w-4"
  viewBox="0 0 24 24"
  aria-hidden="true"
>
  <path
    d="m13.11 7.664 1.78 2.672M14.162 12.788l-3.324 1.424M20 4l-6.06 1.515M3 3v16a2 2 0 0 0 2 2h16"
  />
  <circle cx="12" cy="6" r="2" />
  <circle cx="16" cy="12" r="2" />
  <circle cx="9" cy="15" r="2" />
</svg>

        <span>Graph</span>
      </h2>

      <content-network-graph
  class="h-64 ml-6"
  data-endpoint="/graph/index.json"
  page="/posts/kasan-with-gcc/"
></content-network-graph>

    </section>
</aside>


      </main>
      <footer class="mt-20 border-t border-neutral-100 pt-2 text-xs">
        <section class="items-top flex flex-row justify-between opacity-70">
  <div class="flex flex-col space-y-2">
      <p>Copyright &copy; 2024, Sukbeom Kim.</p>

  </div>
    <div>
      <a
        href="https://github.com/michenriksen/hugo-theme-til"
        title="Today I Learned &#8212; A Hugo theme by Michael Henriksen"
        data-theme-version="0.6.0"
        >theme: til</a
      >
    </div>
</section>

      </footer>
    </div>
    
  </body>
</html>
