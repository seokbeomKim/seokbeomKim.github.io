<!doctype html>
<html
  lang="en-us"
  dir="ltr"
>
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
<meta name="language" content="en" />
<meta name="viewport" content="width=device-width" />
<title>
    커널에서의 Object-Oriented Design Pattern | 평범한 개발자
</title>
  <meta name="description" content="개요 현업에서 BSP 코드를 수정하다가 문득 든 생각은 ‘왜 객체 지향의 디자인 패턴을 적용하지 않는 걸까?’ 라는 것이다. 그러한 디자인 패턴은 이미 오래 전부터 적용되어 왔지만 BSP에 포함된 솔루션 코드로서 추가되는 코드에는 그러한 디자인 패턴이 보이지 않는다.
Java나 C&#43;&#43;, 그리고 완전하지는 않지만 prototype을 이용한 Javascript에서도 객체 지향적인 디자인 패턴이 적용되어 있다. 그렇다면, C와 어셈블리어로 짜여진 커널에서는 이러한 디자인 패턴이 어떻게 적용되어 있을까. 여기에 대한 좋은 참고 자료로서 LWN의 한 기사를 찾을 수 있었다." />
<meta property="og:url" content="http://localhost:1313/posts/oop-in-kernel/">
  <meta property="og:site_name" content="평범한 개발자">
  <meta property="og:title" content="커널에서의 Object-Oriented Design Pattern">
  <meta property="og:description" content="개요 현업에서 BSP 코드를 수정하다가 문득 든 생각은 ‘왜 객체 지향의 디자인 패턴을 적용하지 않는 걸까?’ 라는 것이다. 그러한 디자인 패턴은 이미 오래 전부터 적용되어 왔지만 BSP에 포함된 솔루션 코드로서 추가되는 코드에는 그러한 디자인 패턴이 보이지 않는다.
Java나 C&#43;&#43;, 그리고 완전하지는 않지만 prototype을 이용한 Javascript에서도 객체 지향적인 디자인 패턴이 적용되어 있다. 그렇다면, C와 어셈블리어로 짜여진 커널에서는 이러한 디자인 패턴이 어떻게 적용되어 있을까. 여기에 대한 좋은 참고 자료로서 LWN의 한 기사를 찾을 수 있었다.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-07-25T16:25:23+09:00">
    <meta property="article:modified_time" content="2020-07-25T16:25:23+09:00">
    <meta property="article:tag" content="Kernel">


  <meta itemprop="name" content="커널에서의 Object-Oriented Design Pattern">
  <meta itemprop="description" content="개요 현업에서 BSP 코드를 수정하다가 문득 든 생각은 ‘왜 객체 지향의 디자인 패턴을 적용하지 않는 걸까?’ 라는 것이다. 그러한 디자인 패턴은 이미 오래 전부터 적용되어 왔지만 BSP에 포함된 솔루션 코드로서 추가되는 코드에는 그러한 디자인 패턴이 보이지 않는다.
Java나 C&#43;&#43;, 그리고 완전하지는 않지만 prototype을 이용한 Javascript에서도 객체 지향적인 디자인 패턴이 적용되어 있다. 그렇다면, C와 어셈블리어로 짜여진 커널에서는 이러한 디자인 패턴이 어떻게 적용되어 있을까. 여기에 대한 좋은 참고 자료로서 LWN의 한 기사를 찾을 수 있었다.">
  <meta itemprop="datePublished" content="2020-07-25T16:25:23+09:00">
  <meta itemprop="dateModified" content="2020-07-25T16:25:23+09:00">
  <meta itemprop="wordCount" content="782">
  <meta itemprop="keywords" content="Kernel">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="커널에서의 Object-Oriented Design Pattern">
  <meta name="twitter:description" content="개요 현업에서 BSP 코드를 수정하다가 문득 든 생각은 ‘왜 객체 지향의 디자인 패턴을 적용하지 않는 걸까?’ 라는 것이다. 그러한 디자인 패턴은 이미 오래 전부터 적용되어 왔지만 BSP에 포함된 솔루션 코드로서 추가되는 코드에는 그러한 디자인 패턴이 보이지 않는다.
Java나 C&#43;&#43;, 그리고 완전하지는 않지만 prototype을 이용한 Javascript에서도 객체 지향적인 디자인 패턴이 적용되어 있다. 그렇다면, C와 어셈블리어로 짜여진 커널에서는 이러한 디자인 패턴이 어떻게 적용되어 있을까. 여기에 대한 좋은 참고 자료로서 LWN의 한 기사를 찾을 수 있었다.">

<link rel="canonical" href="http://localhost:1313/posts/oop-in-kernel/" />

    <link rel="stylesheet" href="/css/index.css" />


      <script src="/js/main.js" defer></script>
  
  



<script type="application/ld+json">
{
  "@context": "https://schema.org/",
  "@id": "http://localhost:1313/posts/oop-in-kernel/",
  "@type": "BlogPosting",
  "articleSection": [
    "Linux",
    "Design Pattern",
    "Oop"
  ],
  "author": {
    "@type": "Person",
    "email": "sukbeom.kim@gmail.com",
    "name": "Sukbeom Kim",
    "url": "http://localhost:1313/about/"
  },
  "copyrightNotice": "Sukbeom Kim",
  "datePublished": "2020-07-25",
  "description": "개요 현업에서 BSP 코드를 수정하다가 문득 든 생각은 ‘왜 객체 지향의 디자인 패턴을 적용하지 않는 걸까?’ 라는 것이다. 그러한 디자인 패턴은 이미 오래 전부터 적용되어 왔지만 BSP에 포함된 솔루션 코드로서 추가되는 코드에는 그러한 디자인 패턴이 보이지 않는다.\nJava나 C++, 그리고 완전하지는 않지만 prototype을 이용한 Javascript에서도 객체 지향적인 디자인 패턴이 적용되어 있다. 그렇다면, C와 어셈블리어로 짜여진 커널에서는 이러한 디자인 패턴이 어떻게 적용되어 있을까. 여기에 대한 좋은 참고 자료로서 LWN의 한 기사를 찾을 수 있었다.",
  "headline": "커널에서의 Object-Oriented Design Pattern",
  "isPartOf": {
    "@id": "http://localhost:1313/posts/",
    "@type": "Blog",
    "name": "Posts"
  },
  "keywords": [
    "Kernel"
  ],
  "mainEntityOfPage": "http://localhost:1313/posts/oop-in-kernel/",
  "name": "커널에서의 Object-Oriented Design Pattern",
  "timeRequired": "PT4M",
  "url": "http://localhost:1313/posts/oop-in-kernel/",
  "wordCount": 782
}
</script>


  </head>
  <body>
    <div class="container mx-auto flex max-w-prose flex-col space-y-10 p-4 md:p-6">
      <header class="flex flex-row items-center justify-between">
        <div>
  <a id="skip-nav" class="sr-only" href="#maincontent">Skip to main content</a>
  <a class="font-semibold" href="/">평범한 개발자</a>
</div>

  <nav>
    <ul class="flex flex-row items-center justify-end space-x-4">
    <li>
      <a aria-current="true" class="ancestor" href="/posts/">Posts</a
      >
    </li>
    <li>
      <a href="/graph/">Graph</a
      >
    </li>
    <li>
      <a href="/about/">About</a
      >
    </li>
    </ul>
  </nav>


      </header>
      <main class="prose prose-slate relative md:prose-lg prose-h1:text-[2em]" id="maincontent">
        <article class="main">
    <header>
      <h1 class="!mb-1">커널에서의 Object-Oriented Design Pattern</h1><div class="flex flex-row items-center space-x-4">
          <time class="text-sm italic opacity-80" datetime="2020-07-25T16:25:23&#43;09:00"
            >July 25, 2020</time
          >
        </div>
    </header>

    <h2 id="개요" class="scroll-mt-8 group">
  개요
  
    <a href="#%ea%b0%9c%ec%9a%94"
        class="no-underline hidden opacity-50 hover:opacity-100 !text-inherit group-hover:inline-block"
        aria-hidden="true" title="Link to this heading" tabindex="-1">
        <svg
  xmlns="http://www.w3.org/2000/svg"
  width="16"
  height="16"
  fill="none"
  stroke="currentColor"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  class="lucide lucide-link w-4 h-4 block"
  viewBox="0 0 24 24"
>
  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
</svg>

    </a>
  
</h2>
<p>현업에서 BSP 코드를 수정하다가 문득 든 생각은 &lsquo;왜 객체 지향의 디자인
패턴을 적용하지 않는 걸까?&rsquo; 라는 것이다. 그러한 디자인 패턴은 이미
오래 전부터 적용되어 왔지만 BSP에 포함된 솔루션 코드로서 추가되는
코드에는 그러한 디자인 패턴이 보이지 않는다.</p>
<p>Java나 C++, 그리고 완전하지는 않지만 <code>prototype</code>을 이용한
Javascript에서도 객체 지향적인 디자인 패턴이 적용되어 있다. 그렇다면,
C와 어셈블리어로 짜여진 커널에서는 이러한 디자인 패턴이 어떻게
적용되어 있을까. 여기에 대한 좋은 참고 자료로서 LWN의 한 기사를 찾을
수 있었다.</p>
<ul>
<li><a href="https://lwn.net/Articles/446317/">https://lwn.net/Articles/446317/</a></li>
</ul>
<p>학부 시절부터 오랫동안 들어온 객체의 정의는 <code>state</code>와
<code>behavior</code>이다. 이들은 각각 클래스의 멤버 변수와 메서드 형태로
구현되는데, 이러한 디자인 패턴 자체는 C를 이용해서도 표현이
가능하다. 멤버와 메서드는 각각 구조체 멤버와 <code>vtable(virtual function table)</code> 형태로 표현될 수 있다. 그리고 데이터 상속의 개념으로서
<code>union</code>과 <code>void*</code>, <code>embedded structure</code> 등의 기법을 이용한다.</p>
<p>이 포스팅에서는 커널 코드에서 활용하는 객체지향 디자인 패턴의 기본적인
개념만을 언급한다. 좀 더 자세한 내용이나 실제 코드는 참고자료로 활용한
링크와 커널 코드를 살펴보자.</p>
<h2 id="메서드" class="scroll-mt-8 group">
  메서드
  
    <a href="#%eb%a9%94%ec%84%9c%eb%93%9c"
        class="no-underline hidden opacity-50 hover:opacity-100 !text-inherit group-hover:inline-block"
        aria-hidden="true" title="Link to this heading" tabindex="-1">
        <svg
  xmlns="http://www.w3.org/2000/svg"
  width="16"
  height="16"
  fill="none"
  stroke="currentColor"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  class="lucide lucide-link w-4 h-4 block"
  viewBox="0 0 24 24"
>
  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
</svg>

    </a>
  
</h2>
<p>일반적으로 메서드를 생각하면, C에서 함수 포인터를 구조체에 정의하는
것을 떠올린다. 하지만 커널에서는 직접적으로 구조체 안에 함수 포인터를
사용하는 대신에 <code>vtable</code>을 만들어 <code>_ops</code> 으로 명명한 별도의 함수
테이블을 사용한다. 예를 들어, media framework로 유명한 <code>V4L2</code>를
이용하는 <code>videobuf2</code>를 살펴보자. 영상 프레임을 관리하는 큐에서 메모리
관리에 관련된 메서드는 아래와 같이 정의하여 사용한다.</p>
<figure class="codeblock not-prose relative scroll-mt-8" id="codeblock-01">
  <aside
    class="absolute right-0 top-0 hidden rounded-bl-sm rounded-tr-sm bg-white/10 px-2 py-1 text-white/70 transition-opacity md:inline-block"
  >
    <div class="codeblock-meta flex max-w-xs flex-row items-center space-x-3">
      <div class="small-caps shrink cursor-default truncate font-mono text-xs" aria-hidden="true">
        <span class="relative">c&#43;&#43;</span>
      </div>
      <div>
        <clipboard-copy
          type="button"
          aria-label="Copy code to clipboard"
          title="Copy code to clipboard"
          class="block cursor-pointer transition-colors hover:text-sky-400"
          target="#codeblock-01 code"
        >
          <svg
  xmlns="http://www.w3.org/2000/svg"
  fill="none"
  stroke="currentColor"
  stroke-width="2"
  stroke-linecap="round"
  stroke-linejoin="round"
  class="lucide lucide-clipboard h-4 w-4"
  viewBox="0 0 24 24"
>
  <rect width="8" height="4" x="8" y="2" rx="1" ry="1" />
  <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
</svg>

        </clipboard-copy>
      </div>
      <div>
        <a
          href="#codeblock-01"
          class="block"
          aria-label="Link to this code block"
          title="Link to this code block"
        >
          <svg
  xmlns="http://www.w3.org/2000/svg"
  width="16"
  height="16"
  fill="none"
  stroke="currentColor"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  class="lucide lucide-link w-4 h-4 block"
  viewBox="0 0 24 24"
>
  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
</svg>

        </a>
      </div>
    </div>
  </aside>
  <p class="sr-only">c&#43;&#43; code snippet start</p>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">vb2_queue</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">io_modes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="nc">device</span>			<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">dma_attrs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="k">struct</span> <span class="nc">vb2_ops</span>		<span class="o">*</span><span class="n">ops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="k">struct</span> <span class="nc">vb2_mem_ops</span>	<span class="o">*</span><span class="n">mem_ops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">...</span></span></span></code></pre></div>
  <p class="sr-only">c&#43;&#43; code snippet end</p>

  
</figure>
<p>그리고 <code>vb2_queue</code>에서 메서드 dispatch를 위해서 사용하는 메모리 관련
메서드는 아래와 같이 정의한다.</p>
<figure class="codeblock not-prose relative scroll-mt-8" id="codeblock-02">
  <aside
    class="absolute right-0 top-0 hidden rounded-bl-sm rounded-tr-sm bg-white/10 px-2 py-1 text-white/70 transition-opacity md:inline-block"
  >
    <div class="codeblock-meta flex max-w-xs flex-row items-center space-x-3">
      <div class="small-caps shrink cursor-default truncate font-mono text-xs" aria-hidden="true">
        <span class="relative">c&#43;&#43;</span>
      </div>
      <div>
        <clipboard-copy
          type="button"
          aria-label="Copy code to clipboard"
          title="Copy code to clipboard"
          class="block cursor-pointer transition-colors hover:text-sky-400"
          target="#codeblock-02 code"
        >
          <svg
  xmlns="http://www.w3.org/2000/svg"
  fill="none"
  stroke="currentColor"
  stroke-width="2"
  stroke-linecap="round"
  stroke-linejoin="round"
  class="lucide lucide-clipboard h-4 w-4"
  viewBox="0 0 24 24"
>
  <rect width="8" height="4" x="8" y="2" rx="1" ry="1" />
  <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
</svg>

        </clipboard-copy>
      </div>
      <div>
        <a
          href="#codeblock-02"
          class="block"
          aria-label="Link to this code block"
          title="Link to this code block"
        >
          <svg
  xmlns="http://www.w3.org/2000/svg"
  width="16"
  height="16"
  fill="none"
  stroke="currentColor"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  class="lucide lucide-link w-4 h-4 block"
  viewBox="0 0 24 24"
>
  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
</svg>

        </a>
      </div>
    </div>
  </aside>
  <p class="sr-only">c&#43;&#43; code snippet start</p>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">vb2_mem_ops</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span>		<span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">alloc</span><span class="p">)(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">attrs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				  <span class="k">enum</span> <span class="nc">dma_data_direction</span> <span class="n">dma_dir</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				  <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">put</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf_priv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="nc">dma_buf</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">get_dmabuf</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf_priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span>		<span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">get_userptr</span><span class="p">)(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vaddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="k">enum</span> <span class="nc">dma_data_direction</span> <span class="n">dma_dir</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">put_userptr</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf_priv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">prepare</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf_priv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">finish</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf_priv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span>		<span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">attach_dmabuf</span><span class="p">)(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					  <span class="k">struct</span> <span class="nc">dma_buf</span> <span class="o">*</span><span class="n">dbuf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					  <span class="k">enum</span> <span class="nc">dma_data_direction</span> <span class="n">dma_dir</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">detach_dmabuf</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf_priv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span>		<span class="p">(</span><span class="o">*</span><span class="n">map_dmabuf</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf_priv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">unmap_dmabuf</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf_priv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span>		<span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">vaddr</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf_priv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span>		<span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">cookie</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf_priv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="nf">int</span>	<span class="p">(</span><span class="o">*</span><span class="n">num_users</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf_priv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span>		<span class="p">(</span><span class="o">*</span><span class="n">mmap</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf_priv</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre></div>
  <p class="sr-only">c&#43;&#43; code snippet end</p>

  
</figure>
<p><code>virtual function table</code>을 사용할 경우 객체별로 사용할 수 있는
메서드들에 대한 인터페이스만 정의하고 실제 메서드에 대한 내용은 별도로
구현하여 사용할 수 있다. 즉, 클래스로 정의된 메서드 내용은 같지만 구현
내용은 객체마다 서로 다르게 할 수 있다는 장점이 있다.</p>
<p>그리고 <code>vtable</code>은 메서드에 대한 다중상속을 가능하게 하는데,
<code>closure</code>와 같은 다른 언어에서 <code>mixin</code>이라 표현하는 것처럼 응용할 수
있다. 서로 다른 객체에 대해 같은 메서드를 사용할 수 있도록 하는
방법이다.</p>
<h2 id="데이터-상속" class="scroll-mt-8 group">
  데이터 상속
  
    <a href="#%eb%8d%b0%ec%9d%b4%ed%84%b0-%ec%83%81%ec%86%8d"
        class="no-underline hidden opacity-50 hover:opacity-100 !text-inherit group-hover:inline-block"
        aria-hidden="true" title="Link to this heading" tabindex="-1">
        <svg
  xmlns="http://www.w3.org/2000/svg"
  width="16"
  height="16"
  fill="none"
  stroke="currentColor"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  class="lucide lucide-link w-4 h-4 block"
  viewBox="0 0 24 24"
>
  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
</svg>

    </a>
  
</h2>
<p>예전부터 데이터 상속은 여러 형태로 존재해왔는데, 여기서는 아래 세 가지
형태의 데이터 상속을 다루도록 한다.</p>
<ul>
<li><code>union</code>을 이용한 데이터 상속</li>
<li><code>void*</code>를 이용한 데이터 상속</li>
<li>상속하고자 하는 데이터 직접 내포</li>
</ul>
<h3 id="union을-이용한-데이터-상속" class="scroll-mt-8 group">
  union을 이용한 데이터 상속
  
    <a href="#union%ec%9d%84-%ec%9d%b4%ec%9a%a9%ed%95%9c-%eb%8d%b0%ec%9d%b4%ed%84%b0-%ec%83%81%ec%86%8d"
        class="no-underline hidden opacity-50 hover:opacity-100 !text-inherit group-hover:inline-block"
        aria-hidden="true" title="Link to this heading" tabindex="-1">
        <svg
  xmlns="http://www.w3.org/2000/svg"
  width="16"
  height="16"
  fill="none"
  stroke="currentColor"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  class="lucide lucide-link w-4 h-4 block"
  viewBox="0 0 24 24"
>
  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
</svg>

    </a>
  
</h3>
<p><code>struct inode</code>를 살펴보면 아래와 같은 코드를 살펴볼 수 있다.</p>
<figure class="codeblock not-prose relative scroll-mt-8" id="codeblock-03">
  <aside
    class="absolute right-0 top-0 hidden rounded-bl-sm rounded-tr-sm bg-white/10 px-2 py-1 text-white/70 transition-opacity md:inline-block"
  >
    <div class="codeblock-meta flex max-w-xs flex-row items-center space-x-3">
      <div class="small-caps shrink cursor-default truncate font-mono text-xs" aria-hidden="true">
        <span class="relative">c&#43;&#43;</span>
      </div>
      <div>
        <clipboard-copy
          type="button"
          aria-label="Copy code to clipboard"
          title="Copy code to clipboard"
          class="block cursor-pointer transition-colors hover:text-sky-400"
          target="#codeblock-03 code"
        >
          <svg
  xmlns="http://www.w3.org/2000/svg"
  fill="none"
  stroke="currentColor"
  stroke-width="2"
  stroke-linecap="round"
  stroke-linejoin="round"
  class="lucide lucide-clipboard h-4 w-4"
  viewBox="0 0 24 24"
>
  <rect width="8" height="4" x="8" y="2" rx="1" ry="1" />
  <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
</svg>

        </clipboard-copy>
      </div>
      <div>
        <a
          href="#codeblock-03"
          class="block"
          aria-label="Link to this code block"
          title="Link to this code block"
        >
          <svg
  xmlns="http://www.w3.org/2000/svg"
  width="16"
  height="16"
  fill="none"
  stroke="currentColor"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  class="lucide lucide-link w-4 h-4 block"
  viewBox="0 0 24 24"
>
  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
</svg>

        </a>
      </div>
    </div>
  </aside>
  <p class="sr-only">c&#43;&#43; code snippet start</p>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"> <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="k">struct</span> <span class="nc">minix_inode_info</span> <span class="n">minix_i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">               <span class="k">struct</span> <span class="nc">ext_inode_info</span> <span class="n">ext_i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">               <span class="k">struct</span> <span class="nc">msdos_inode_info</span> <span class="n">msdos_i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span> <span class="n">u</span><span class="p">;</span></span></span></code></pre></div>
  <p class="sr-only">c&#43;&#43; code snippet end</p>

  
</figure>
<p><code>inode</code> 안에서 <code>union</code>을 이용하여 노드에 대한 정보를 관리한다고 했을
때, 해당 <code>inode</code> 클래스는 상기 세 가지 중 하나에 대한 데이터를
상속하게 된다. 이는 직관적으로 코드를 이해할 수 있다는 장점이 있지만,
<code>union</code>을 사용하는 까닭에 padding을 위해 필요한 메모리 낭비로 이어질
수 있다.</p>
<h3 id="void-이용한-데이터-상속" class="scroll-mt-8 group">
  void* 이용한 데이터 상속
  
    <a href="#void-%ec%9d%b4%ec%9a%a9%ed%95%9c-%eb%8d%b0%ec%9d%b4%ed%84%b0-%ec%83%81%ec%86%8d"
        class="no-underline hidden opacity-50 hover:opacity-100 !text-inherit group-hover:inline-block"
        aria-hidden="true" title="Link to this heading" tabindex="-1">
        <svg
  xmlns="http://www.w3.org/2000/svg"
  width="16"
  height="16"
  fill="none"
  stroke="currentColor"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  class="lucide lucide-link w-4 h-4 block"
  viewBox="0 0 24 24"
>
  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
</svg>

    </a>
  
</h3>
<p>커널에 정의된 프레임워크를 이용하다 보면 종종 <code>void* private;</code> 으로
정의된 것이 구조체 안에 정의되어 있는 것을 알 수 있다. 위에서
<code>union</code>을 사용한 것과 달리 <code>void*</code> 사용하게 되면 불필요한 메모리는
줄일 수 있고 데이터 상속에 대한 유연성을 갖출 수 있지만 **실제로 어떤
데이터를 사용해야 하는가?**에 대한 질문에 직관적인 해석을 가져다 주지
못한다. 여전히 V4L 프레임워크와 같이 몇 군데에서 <code>void* private;</code>
형태로 사용되고 있지만 문서화와 쉽게 코드를 파악할 수 있는 구조가
아니라면, 이러한 포인터 형태는 지양되어야 한다.</p>
<h3 id="embedded-structure" class="scroll-mt-8 group">
  embedded structure
  
    <a href="#embedded-structure"
        class="no-underline hidden opacity-50 hover:opacity-100 !text-inherit group-hover:inline-block"
        aria-hidden="true" title="Link to this heading" tabindex="-1">
        <svg
  xmlns="http://www.w3.org/2000/svg"
  width="16"
  height="16"
  fill="none"
  stroke="currentColor"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  class="lucide lucide-link w-4 h-4 block"
  viewBox="0 0 24 24"
>
  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
</svg>

    </a>
  
</h3>
<p>직접적으로 필요한 데이터들을 구조체 안에 멤버 변수로 정의하고,
<code>container_of</code> 매크로를 통해 부모 객체에 접근하도록 구현하는
방법이다. <code>void*</code> 에 비해 유연성은 떨어지지만 명시적으로 어떤 데이터를
상속하는지 나타낼 수 있고 매크로를 통해 부모에 정의되어 있는 함수
테이블을 이용하는 등 객체 지향 패턴을 적용하는데 무리가 없다. 여러
파일시스템의 코드를 살펴보면 아래와 같이 기본적인 <code>inode</code>에 대한
데이터 자체를 아래와 같이 내포한 형태로 사용하는 것을 알 수 있다.</p>
<figure class="codeblock not-prose relative scroll-mt-8" id="codeblock-04">
  <aside
    class="absolute right-0 top-0 hidden rounded-bl-sm rounded-tr-sm bg-white/10 px-2 py-1 text-white/70 transition-opacity md:inline-block"
  >
    <div class="codeblock-meta flex max-w-xs flex-row items-center space-x-3">
      <div class="small-caps shrink cursor-default truncate font-mono text-xs" aria-hidden="true">
        <span class="relative">c&#43;&#43;</span>
      </div>
      <div>
        <clipboard-copy
          type="button"
          aria-label="Copy code to clipboard"
          title="Copy code to clipboard"
          class="block cursor-pointer transition-colors hover:text-sky-400"
          target="#codeblock-04 code"
        >
          <svg
  xmlns="http://www.w3.org/2000/svg"
  fill="none"
  stroke="currentColor"
  stroke-width="2"
  stroke-linecap="round"
  stroke-linejoin="round"
  class="lucide lucide-clipboard h-4 w-4"
  viewBox="0 0 24 24"
>
  <rect width="8" height="4" x="8" y="2" rx="1" ry="1" />
  <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
</svg>

        </clipboard-copy>
      </div>
      <div>
        <a
          href="#codeblock-04"
          class="block"
          aria-label="Link to this code block"
          title="Link to this code block"
        >
          <svg
  xmlns="http://www.w3.org/2000/svg"
  width="16"
  height="16"
  fill="none"
  stroke="currentColor"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  class="lucide lucide-link w-4 h-4 block"
  viewBox="0 0 24 24"
>
  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
</svg>

        </a>
      </div>
    </div>
  </aside>
  <p class="sr-only">c&#43;&#43; code snippet start</p>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cm">/* in memory btrfs inode */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">btrfs_inode</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* which subvolume this inode belongs to */</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="nc">btrfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* key used to find this inode on disk.  This is used by the code
</span></span></span><span class="line"><span class="cl"><span class="cm">     * to read in roots of subvolumes
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="nc">btrfs_key</span> <span class="n">location</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="nc">inode</span> <span class="n">vfs_inode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre></div>
  <p class="sr-only">c&#43;&#43; code snippet end</p>

  
</figure>
<h2 id="결론" class="scroll-mt-8 group">
  결론
  
    <a href="#%ea%b2%b0%eb%a1%a0"
        class="no-underline hidden opacity-50 hover:opacity-100 !text-inherit group-hover:inline-block"
        aria-hidden="true" title="Link to this heading" tabindex="-1">
        <svg
  xmlns="http://www.w3.org/2000/svg"
  width="16"
  height="16"
  fill="none"
  stroke="currentColor"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  class="lucide lucide-link w-4 h-4 block"
  viewBox="0 0 24 24"
>
  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
</svg>

    </a>
  
</h2>
<p>객체지향 패턴을 적용하는 것은 중요하지만 만능은 아니다. 모든 곳에
이러한 객체 지향 디자인 패턴을 적용해야 하는 것은 잘못된 것이고 오히려
분석을 어렵게 만들 수도 있다. 디자인 패턴은 어디까지나 디자인 패턴일
뿐. 언어 때문에 특정 디자인 패턴을 적용할 수 없다는 얘기도 반은 맞고
반은 틀렸다. 커널에서 사용되는 <code>kref</code> 형태의 reference count 또한 특정
언어에 국한된 설계 패턴이 아니다. 타겟과 개발 환경에 따라 필요성과
효율성이 달라지는 것일 뿐 정답은 없다.</p>

  </article>
    <aside class="not-prose flex flex-col space-y-8 border-t pt-6">
    <section class="flex flex-col space-y-4">
      <h2 class="flex flex-row items-center space-x-2 text-lg font-semibold">
        <svg
  xmlns="http://www.w3.org/2000/svg"
  fill="none"
  stroke="currentColor"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  class="lucide lucide-shapes h-4 w-4"
  viewBox="0 0 24 24"
  aria-hidden="true"
>
  <path
    d="M8.3 10a.7.7 0 0 1-.626-1.079L11.4 3a.7.7 0 0 1 1.198-.043L16.3 8.9a.7.7 0 0 1-.572 1.1Z"
  />
  <rect width="7" height="7" x="3" y="14" rx="1" />
  <circle cx="17.5" cy="17.5" r="3.5" />
</svg>

        <span>Categories</span>
      </h2>

      <ul class="ml-6 flex flex-row flex-wrap items-center space-x-2">
          <li>
            <a href="/categories/linux/" class="taxonomy category">linux</a>
          </li>
          <li>
            <a href="/categories/design-pattern/" class="taxonomy category">design pattern</a>
          </li>
          <li>
            <a href="/categories/oop/" class="taxonomy category">oop</a>
          </li>
      </ul>
    </section>
    <section class="flex flex-col space-y-4">
      <h2 class="flex flex-row items-center space-x-2 text-lg font-semibold">
        <svg
  xmlns="http://www.w3.org/2000/svg"
  fill="none"
  stroke="currentColor"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  class="lucide lucide-tags h-4 w-4"
  viewBox="0 0 24 24"
  aria-hidden="true"
>
  <path d="m15 5 6.3 6.3a2.4 2.4 0 0 1 0 3.4L17 19" />
  <path
    d="M9.586 5.586A2 2 0 0 0 8.172 5H3a1 1 0 0 0-1 1v5.172a2 2 0 0 0 .586 1.414L8.29 18.29a2.426 2.426 0 0 0 3.42 0l3.58-3.58a2.426 2.426 0 0 0 0-3.42z"
  />
  <circle cx="6.5" cy="9.5" r=".5" fill="currentColor" />
</svg>

        <span>Tags</span>
      </h2>

      <ul class="not-prose ml-6 flex flex-row flex-wrap items-center space-x-2">
          <li>
            <a href="/tags/kernel/" class="taxonomy tag">kernel</a>
          </li>
      </ul>
    </section>
    <section class="flex flex-col space-y-4" aria-hidden="true">
      <h2 class="flex flex-row items-center space-x-2 text-lg font-semibold">
        <svg
  xmlns="http://www.w3.org/2000/svg"
  fill="none"
  stroke="currentColor"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  class="lucide lucide-chart-network h-4 w-4"
  viewBox="0 0 24 24"
  aria-hidden="true"
>
  <path
    d="m13.11 7.664 1.78 2.672M14.162 12.788l-3.324 1.424M20 4l-6.06 1.515M3 3v16a2 2 0 0 0 2 2h16"
  />
  <circle cx="12" cy="6" r="2" />
  <circle cx="16" cy="12" r="2" />
  <circle cx="9" cy="15" r="2" />
</svg>

        <span>Graph</span>
      </h2>

      <content-network-graph
  class="h-64 ml-6"
  data-endpoint="/graph/index.json"
  page="/posts/oop-in-kernel/"
></content-network-graph>

    </section>
    <section class="flex flex-col space-y-4">
      <h2 class="flex flex-row items-center space-x-2 text-lg font-semibold">
        <svg
  xmlns="http://www.w3.org/2000/svg"
  fill="none"
  stroke="currentColor"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  class="lucide lucide-newspaper h-4 w-4"
  viewBox="0 0 24 24"
  aria-hidden="true"
>
  <path
    d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2M18 14h-8M15 18h-5"
  />
  <path d="M10 6h8v4h-8V6Z" />
</svg>

        <span>Posts</span>
      </h2>
        <section class="flex flex-col space-y-1">
          <h3 class="flex flex-row items-center space-x-2 text-sm font-semibold">
            <svg
  xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 256 256"
  class="h-4 w-4"
  aria-hidden="true"
>
  <path
    fill="currentColor"
    d="M222.16 153.26a8 8 0 0 1-1 11.25c-17.36 14.38-32.86 19.49-47 19.49-18.58 0-34.82-8.81-49.93-17-25.35-13.75-47.24-25.63-79.07.74a8 8 0 1 1-10.22-12.3c40.17-33.27 70.32-16.92 96.93-2.48 25.35 13.75 47.24 25.62 79.07-.75a8 8 0 0 1 11.22 1.05m-177-49.46c31.83-26.37 53.72-14.5 79.07-.75 15.11 8.2 31.35 17 49.93 17 14.14 0 29.64-5.11 47-19.49a8 8 0 1 0-10.22-12.3c-31.83 26.37-53.72 14.49-79.07.74-26.61-14.43-56.76-30.79-96.93 2.48a8 8 0 0 0 10.17 12.32Z"
  />
</svg>

            <span>Related</span>
          </h3>

          <ol class="not-prose ml-6">
    <li>
      <article class="flex flex-row items-center">
        <header class="grow">
          <h3>
            <a
              href="/posts/build-kernel-and-busybox2/"
              class="truncate text-sm underline decoration-slate-300 decoration-2 underline-offset-4 hover:decoration-inherit"
              title="Linux 커널, Busybox 빌드 후 QEMU에서 실행하기(2/2)"
              >Linux 커널, Busybox 빌드 후 QEMU에서 실행하기(2/2)</a
            >
          </h3>
        </header>
          <ul class="flex flex-row items-center justify-end space-x-2">
              <li>
                <a
                  href="/categories/kernel/"
                  class="taxonomy"
                  title="Posts and notes on Kernel"
                  >Kernel</a
                >
              </li>
          </ul>
      </article>
    </li>
</ol>

        </section>
    </section>
</aside>


      </main>
      <footer class="mt-20 border-t border-neutral-100 pt-2 text-xs">
        <section class="items-top flex flex-row justify-between opacity-70">
  <div class="flex flex-col space-y-2">
      <p>Copyright &copy; 2024, Sukbeom Kim.</p>

  </div>
    <div>
      <a
        href="https://github.com/michenriksen/hugo-theme-til"
        title="Today I Learned &#8212; A Hugo theme by Michael Henriksen"
        data-theme-version="0.6.0"
        >theme: til</a
      >
    </div>
</section>

      </footer>
    </div>
    
  </body>
</html>
